!function(e){function t(i){if(r[i])return r[i].exports;var a=r[i]={exports:{},id:i,loaded:!1};return e[i].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){if("undefined"==typeof AFRAME)throw new Error("Component attempted to register before AFRAME was available.");r(5),r(4),r(3),r(1),r(2);var i=new THREE.MMDLoader,a=new THREE.MMDHelper({getSize:function(){return{width:1,height:1}},setSize:function(e,t){}});AFRAME.registerComponent("mmd",{schema:{audio:{type:"string"},volume:{type:"number",default:1},audioDelayTime:{type:"number"},afterglow:{type:"number"}},init:function(){this.effect=null,this.ready=!1;this.loader=i,this.helper=new THREE.MMDHelper({getSize:function(){return{width:1,height:1}},setSize:function(e,t){}}),this.entityCount=this.getMMDEntityCount(this.el),this.el.addEventListener("model-loaded",this.onModelLoaded.bind(this))},setupOutlineEffect:function(e){var t=e.sceneEl,r=t.renderer;t.effect;if(void 0!==r){for(var i=Object.keys(r),a=0,n=i.length;a<n;a++){var o=i[a];void 0===THREE.OutlineEffect.prototype[o]&&(THREE.OutlineEffect.prototype[o]="function"==typeof r[o]?r[o].bind(r):r[o])}this.effect=new THREE.OutlineEffect(r),t.effect=new THREE.VREffect(this.effect)}},getMMDEntityCount:function(e){for(var t=e.querySelectorAll("a-entity"),r=0,i=0,a=t.length;i<a;i++){var n=t[i];null!==n.getAttribute("mmd-model")&&r++}return r},update:function(){function e(){n.loadAudio(r,function(e,r){1!==i&&e.setVolume(i),r.position.z=1;var n={};0!==a&&(n.delayTime=a),o.setAudio(e,r,n),t.checkIfReady()})}var t=this,r=(this.el,this.data.audio),i=this.data.volume,a=this.data.audioDelayTime,n=this.loader,o=this.helper;""!==r?e():this.checkIfReady()},setBlink:function(e){var t="まばたき";this.removeBlinkFromMorphAnimations(e,t);var r=this.loader,i=10*Math.random()|0,a={metadata:{name:"blink",coordinateSystem:"right",morphCount:14,cameraCount:0,motionCount:0},morphs:[{frameNum:0,morphName:t,weight:0},{frameNum:i+10,morphName:t,weight:0},{frameNum:i+15,morphName:t,weight:1},{frameNum:i+16,morphName:t,weight:1},{frameNum:i+20,morphName:t,weight:0},{frameNum:i+40,morphName:t,weight:0},{frameNum:i+43,morphName:t,weight:1},{frameNum:i+44,morphName:t,weight:1},{frameNum:i+46,morphName:t,weight:0},{frameNum:i+49,morphName:t,weight:0},{frameNum:i+52,morphName:t,weight:1},{frameNum:i+53,morphName:t,weight:1},{frameNum:i+55,morphName:t,weight:0},{frameNum:i+200,morphName:t,weight:0}],cameras:[],motions:[]};r.pourVmdIntoModel(e,a,"blink"),null!==e.mixer&&void 0!==e.mixer||(e.mixer=new THREE.AnimationMixer(e));var n=e.geometry.animations,o=n[n.length-1],s=e.mixer.clipAction(o);s.play(),s.weight=n.length},removeBlinkFromMorphAnimations:function(e,t){if(void 0!==e.geometry.animations&&void 0!==e.morphTargetDictionary){var r=e.morphTargetDictionary[t];if(void 0!==r)for(var i=0,a=e.geometry.animations.length;i<a;i++)for(var n=e.geometry.animations[i].tracks,o=0,s=n.length;o<s;o++)if(n[o].name===".morphTargetInfluences["+r+"]"){n.splice(o,1);break}}},onModelLoaded:function(e){var t=this.helper,r=e.detail.format,i=e.detail.model;"mmd"===r&&(t.setAnimation(i),t.add(i)),this.checkIfReady()},checkIfReady:function(){var e=""!==this.data.audio,t=!e||null!==this.helper.audioManager,r=this.helper.meshes.length>=this.entityCount;t&&r&&this.getReady()},getReady:function(){var e=this.helper,t=this.data.afterglow,r={};0!==t&&(r.afterglow=t),e.unifyAnimationDuration(r);for(var i=0;i<e.meshes.length;i++){var a=e.meshes[i];a.looped=!0,a.blink&&this.setBlink(a),delete a.blink}this.ready=!0},tick:function(e,t){null===this.effect&&this.setupOutlineEffect(this.el),this.ready&&this.helper.animate(t/1e3)}}),AFRAME.registerComponent("mmd-model",{schema:{model:{type:"string"},vpd:{type:"string"},vmd:{type:"string"},physics:{type:"boolean",default:!1},blink:{type:"boolean",default:!1}},init:function(){this.mesh=null,this.loader=i,this.helper=a},update:function(){function e(){h.loadModel(o,function(e){var a=e;u&&d.setPhysics(a),""!==l?r(a):""!==s?t(a):i(a)})}function t(e){h.loadVpd(s,function(t){d.poseAsVpd(e,t),i(e)})}function r(e){var t=l.replace(/\s/g,"").split(",");h.loadVmds(t,function(t){h.pourVmdIntoModel(e,t),i(e)})}function i(e){e.blink=a.data.blink,a.mesh=e,n.setObject3D("mesh",e),n.emit("model-loaded",{format:"mmd",model:e})}var a=this,n=this.el,o=this.data.model,s=this.data.vpd,l=this.data.vmd,u=this.data.physics,h=this.loader,d=this.helper;""!==o&&e()}})},function(e,t){THREE.CCDIKSolver=function(e){this.mesh=e,this._valid()},THREE.CCDIKSolver.prototype={constructor:THREE.CCDIKSolver,_valid:function(){for(var e=this.mesh.geometry.iks,t=this.mesh.skeleton.bones,r=0,i=e.length;r<i;r++){var a,n,o=e[r],s=t[o.effector],l=o.links;a=s;for(var u=0,h=l.length;u<h;u++)n=t[l[u].index],a.parent!==n&&console.warn("THREE.CCDIKSolver: bone "+a.name+" is not the child of bone "+n.name),a=n}},update:function(){var e=new THREE.Quaternion,t=new THREE.Vector3,r=new THREE.Vector3,i=new THREE.Vector3,a=new THREE.Vector3,n=new THREE.Vector3,o=new THREE.Quaternion,s=new THREE.Vector3,l=this.mesh.skeleton.bones,u=this.mesh.geometry.iks,h=(this.mesh.geometry.bones,Math);this.mesh.updateMatrixWorld(!0);for(var d=0,f=u.length;d<f;d++){var c=u[d],m=l[c.effector],p=l[c.target];t.setFromMatrixPosition(p.matrixWorld);for(var g=c.links,v=void 0!==c.iteration?c.iteration:1,E=0;E<v;E++){for(var A=!1,y=0,T=g.length;y<T;y++){var M=l[g[y].index];if(g[y].enabled===!1)break;var R=g[y].limitation;n.setFromMatrixPosition(M.matrixWorld),o.setFromRotationMatrix(M.matrixWorld).inverse(),i.setFromMatrixPosition(m.matrixWorld),a.subVectors(i,n),a.applyQuaternion(o),a.normalize(),r.subVectors(t,n),r.applyQuaternion(o),r.normalize();var x=r.dot(a);if(x>1?x=1:x<-1&&(x=-1),x=h.acos(x),!(x<1e-5)){if(void 0!==c.minAngle&&x<c.minAngle&&(x=c.minAngle),void 0!==c.maxAngle&&x>c.maxAngle&&(x=c.maxAngle),s.crossVectors(a,r),s.normalize(),e.setFromAxisAngle(s,x),M.quaternion.multiply(e),void 0!==R){var b=M.quaternion.w;b>1&&(b=1);var C=h.sqrt(1-b*b);M.quaternion.set(R.x*C,R.y*C,R.z*C,b)}M.updateMatrixWorld(!0),A=!0}}if(!A)break}}this.mesh.updateMatrixWorld(!0)}},THREE.CCDIKHelper=function(e){if(void 0===e.geometry.iks||void 0===e.skeleton)throw"THREE.CCDIKHelper requires iks in mesh.geometry and skeleton in mesh.";THREE.Object3D.call(this),this.root=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.sphereGeometry=new THREE.SphereBufferGeometry(.25,16,8),this.targetSphereMaterial=new THREE.MeshBasicMaterial({color:new THREE.Color(16746632),depthTest:!1,depthWrite:!1,transparent:!0}),this.effectorSphereMaterial=new THREE.MeshBasicMaterial({color:new THREE.Color(8978312),depthTest:!1,depthWrite:!1,transparent:!0}),this.linkSphereMaterial=new THREE.MeshBasicMaterial({color:new THREE.Color(8947967),depthTest:!1,depthWrite:!1,transparent:!0}),this.lineMaterial=new THREE.LineBasicMaterial({color:new THREE.Color(16711680),depthTest:!1,depthWrite:!1,transparent:!0}),this._init(),this.update()},THREE.CCDIKHelper.prototype=Object.create(THREE.Object3D.prototype),THREE.CCDIKHelper.prototype.constructor=THREE.CCDIKHelper,THREE.CCDIKHelper.prototype._init=function(){function e(e){var t=new THREE.BufferGeometry,r=new Float32Array(3*(2+e.links.length));return t.addAttribute("position",new THREE.BufferAttribute(r,3)),t}function t(){return new THREE.Mesh(n.sphereGeometry,n.targetSphereMaterial)}function r(){return new THREE.Mesh(n.sphereGeometry,n.effectorSphereMaterial)}function i(){return new THREE.Mesh(n.sphereGeometry,n.linkSphereMaterial)}function a(t){return new THREE.Line(e(t),n.lineMaterial)}for(var n=this,o=this.root,s=o.geometry.iks,l=0,u=s.length;l<u;l++){var h=s[l];this.add(t()),this.add(r());for(var d=0,f=h.links.length;d<f;d++)this.add(i());this.add(a(h))}},THREE.CCDIKHelper.prototype.update=function(){function e(e){return s.setFromMatrixPosition(e.matrixWorld),s.applyMatrix4(o),s}function t(t,r,i){var a=e(i);t[3*r+0]=a.x,t[3*r+1]=a.y,t[3*r+2]=a.z}for(var r=0,i=this.root,a=i.geometry.iks,n=i.skeleton.bones,o=(new THREE.Matrix4).getInverse(i.matrixWorld),s=new THREE.Vector3,l=0,u=a.length;l<u;l++){var h=a[l],d=n[h.target],f=n[h.effector],c=this.children[r++],m=this.children[r++];c.position.copy(e(d)),m.position.copy(e(f));for(var p=0,g=h.links.length;p<g;p++){var v=h.links[p],E=n[v.index],A=this.children[r++];A.position.copy(e(E))}var y=this.children[r++],T=y.geometry.attributes.position.array;t(T,0,d),t(T,1,f);for(var p=0,g=h.links.length;p<g;p++){var v=h.links[p],E=n[v.index];t(T,p+2,E)}y.geometry.attributes.position.needsUpdate=!0}}},function(e,t){THREE.MMDPhysics=function(e,t){void 0===t&&(t={}),this.mesh=e,this.helper=new THREE.MMDPhysics.ResourceHelper,this.unitStep=void 0!==t.unitStep?t.unitStep:1/65,this.maxStepNum=void 0!==t.maxStepNum?t.maxStepNum:3,this.world=null,this.bodies=[],this.constraints=[],this.init(e)},THREE.MMDPhysics.prototype={constructor:THREE.MMDPhysics,init:function(e){var t=e.parent;null!==t&&t.remove(e);var r=e.position.clone(),i=e.rotation.clone(),a=e.scale.clone();e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1),e.updateMatrixWorld(!0),this.initWorld(),this.initRigidBodies(),this.initConstraints(),null!==t&&t.add(e),e.position.copy(r),e.rotation.copy(i),e.scale.copy(a),e.updateMatrixWorld(!0),this.reset()},initWorld:function(){var e=new Ammo.btDefaultCollisionConfiguration,t=new Ammo.btCollisionDispatcher(e),r=new Ammo.btDbvtBroadphase,i=new Ammo.btSequentialImpulseConstraintSolver,a=new Ammo.btDiscreteDynamicsWorld(t,r,i,e);a.setGravity(new Ammo.btVector3(0,-98,0)),this.world=a},initRigidBodies:function(){for(var e=this.mesh.geometry.rigidBodies,t=0;t<e.length;t++){var r=new THREE.MMDPhysics.RigidBody(this.mesh,this.world,e[t],this.helper);this.bodies.push(r)}},initConstraints:function(){for(var e=this.mesh.geometry.constraints,t=0;t<e.length;t++){var r=e[t],i=this.bodies[r.rigidBodyIndex1],a=this.bodies[r.rigidBodyIndex2],n=new THREE.MMDPhysics.Constraint(this.mesh,this.world,i,a,r,this.helper);this.constraints.push(n)}},update:function(e){var t=this.unitStep,r=e,i=(e/t|0)+1;r<t&&(r=t,i=1),i>this.maxStepNum&&(i=this.maxStepNum),this.updateRigidBodies(),this.world.stepSimulation(r,i,t),this.updateBones()},updateRigidBodies:function(){for(var e=0;e<this.bodies.length;e++)this.bodies[e].updateFromBone()},updateBones:function(){for(var e=0;e<this.bodies.length;e++)this.bodies[e].updateBone()},reset:function(){for(var e=0;e<this.bodies.length;e++)this.bodies[e].reset()},warmup:function(e){for(var t=0;t<e;t++)this.update(1/60)}},THREE.MMDPhysics.ResourceHelper=function(){this.threeVector3s=[],this.threeMatrix4s=[],this.threeQuaternions=[],this.threeEulers=[],this.transforms=[],this.quaternions=[],this.vector3s=[]},THREE.MMDPhysics.ResourceHelper.prototype={allocThreeVector3:function(){return this.threeVector3s.length>0?this.threeVector3s.pop():new THREE.Vector3},freeThreeVector3:function(e){this.threeVector3s.push(e)},allocThreeMatrix4:function(){return this.threeMatrix4s.length>0?this.threeMatrix4s.pop():new THREE.Matrix4},freeThreeMatrix4:function(e){this.threeMatrix4s.push(e)},allocThreeQuaternion:function(){return this.threeQuaternions.length>0?this.threeQuaternions.pop():new THREE.Quaternion},freeThreeQuaternion:function(e){this.threeQuaternions.push(e)},allocThreeEuler:function(){return this.threeEulers.length>0?this.threeEulers.pop():new THREE.Euler},freeThreeEuler:function(e){this.threeEulers.push(e)},allocTransform:function(){return this.transforms.length>0?this.transforms.pop():new Ammo.btTransform},freeTransform:function(e){this.transforms.push(e)},allocQuaternion:function(){return this.quaternions.length>0?this.quaternions.pop():new Ammo.btQuaternion},freeQuaternion:function(e){this.quaternions.push(e)},allocVector3:function(){return this.vector3s.length>0?this.vector3s.pop():new Ammo.btVector3},freeVector3:function(e){this.vector3s.push(e)},setIdentity:function(e){e.setIdentity()},getBasis:function(e){var t=this.allocQuaternion();return e.getBasis().getRotation(t),t},getBasisAsMatrix3:function(e){var t=this.getBasis(e),r=this.quaternionToMatrix3(t);return this.freeQuaternion(t),r},getOrigin:function(e){return e.getOrigin()},setOrigin:function(e,t){e.getOrigin().setValue(t.x(),t.y(),t.z())},copyOrigin:function(e,t){var r=t.getOrigin();this.setOrigin(e,r)},setBasis:function(e,t){e.setRotation(t)},setBasisFromMatrix3:function(e,t){var r=this.matrix3ToQuaternion(t);this.setBasis(e,r),this.freeQuaternion(r)},setOriginFromArray3:function(e,t){e.getOrigin().setValue(t[0],t[1],t[2])},setBasisFromArray3:function(e,t){var r=this.allocThreeQuaternion(),i=this.allocThreeEuler();i.set(t[0],t[1],t[2]),this.setBasisFromArray4(e,r.setFromEuler(i).toArray()),this.freeThreeEuler(i),this.freeThreeQuaternion(r)},setBasisFromArray4:function(e,t){var r=this.array4ToQuaternion(t);this.setBasis(e,r),this.freeQuaternion(r)},array4ToQuaternion:function(e){var t=this.allocQuaternion();return t.setX(e[0]),t.setY(e[1]),t.setZ(e[2]),t.setW(e[3]),t},multiplyTransforms:function(e,t){var r=this.allocTransform();this.setIdentity(r);var i=this.getBasisAsMatrix3(e),a=this.getBasisAsMatrix3(t),n=this.getOrigin(e),o=this.getOrigin(t),s=this.multiplyMatrix3ByVector3(i,o),l=this.addVector3(s,n);this.setOrigin(r,l);var u=this.multiplyMatrices3(i,a);return this.setBasisFromMatrix3(r,u),this.freeVector3(s),this.freeVector3(l),r},inverseTransform:function(e){var t=this.allocTransform(),r=this.getBasisAsMatrix3(e),i=this.getOrigin(e),a=this.transposeMatrix3(r),n=this.negativeVector3(i),o=this.multiplyMatrix3ByVector3(a,n);return this.setOrigin(t,o),this.setBasisFromMatrix3(t,a),this.freeVector3(n),this.freeVector3(o),t},multiplyMatrices3:function(e,t){var r=[],i=this.rowOfMatrix3(e,0),a=this.rowOfMatrix3(e,1),n=this.rowOfMatrix3(e,2),o=this.columnOfMatrix3(t,0),s=this.columnOfMatrix3(t,1),l=this.columnOfMatrix3(t,2);return r[0]=this.dotVectors3(i,o),r[1]=this.dotVectors3(i,s),r[2]=this.dotVectors3(i,l),r[3]=this.dotVectors3(a,o),r[4]=this.dotVectors3(a,s),r[5]=this.dotVectors3(a,l),r[6]=this.dotVectors3(n,o),r[7]=this.dotVectors3(n,s),r[8]=this.dotVectors3(n,l),this.freeVector3(i),this.freeVector3(a),this.freeVector3(n),this.freeVector3(o),this.freeVector3(s),this.freeVector3(l),r},addVector3:function(e,t){var r=this.allocVector3();return r.setValue(e.x()+t.x(),e.y()+t.y(),e.z()+t.z()),r},dotVectors3:function(e,t){return e.x()*t.x()+e.y()*t.y()+e.z()*t.z()},rowOfMatrix3:function(e,t){var r=this.allocVector3();return r.setValue(e[3*t+0],e[3*t+1],e[3*t+2]),r},columnOfMatrix3:function(e,t){var r=this.allocVector3();return r.setValue(e[t+0],e[t+3],e[t+6]),r},negativeVector3:function(e){var t=this.allocVector3();return t.setValue(-e.x(),-e.y(),-e.z()),t},multiplyMatrix3ByVector3:function(e,t){var r=this.allocVector3(),i=this.rowOfMatrix3(e,0),a=this.rowOfMatrix3(e,1),n=this.rowOfMatrix3(e,2),o=this.dotVectors3(i,t),s=this.dotVectors3(a,t),l=this.dotVectors3(n,t);return r.setValue(o,s,l),this.freeVector3(i),this.freeVector3(a),this.freeVector3(n),r},transposeMatrix3:function(e){var t=[];return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],t},quaternionToMatrix3:function(e){var t=[],r=e.x(),i=e.y(),a=e.z(),n=e.w(),o=r*r,s=i*i,l=a*a,u=r*i,h=i*a,d=a*r,f=r*n,c=i*n,m=a*n;return t[0]=1-2*(s+l),t[1]=2*(u-m),t[2]=2*(d+c),t[3]=2*(u+m),t[4]=1-2*(l+o),t[5]=2*(h-f),t[6]=2*(d-c),t[7]=2*(h+f),t[8]=1-2*(o+s),t},matrix3ToQuaternion:function(e){var t,r,i,a,n,o=e[0]+e[4]+e[8];o>0?(t=2*Math.sqrt(o+1),n=.25*t,r=(e[7]-e[5])/t,i=(e[2]-e[6])/t,a=(e[3]-e[1])/t):e[0]>e[4]&&e[0]>e[8]?(t=2*Math.sqrt(1+e[0]-e[4]-e[8]),n=(e[7]-e[5])/t,r=.25*t,i=(e[1]+e[3])/t,a=(e[2]+e[6])/t):e[4]>e[8]?(t=2*Math.sqrt(1+e[4]-e[0]-e[8]),n=(e[2]-e[6])/t,r=(e[1]+e[3])/t,i=.25*t,a=(e[5]+e[7])/t):(t=2*Math.sqrt(1+e[8]-e[0]-e[4]),n=(e[3]-e[1])/t,r=(e[2]+e[6])/t,i=(e[5]+e[7])/t,a=.25*t);var s=this.allocQuaternion();return s.setX(r),s.setY(i),s.setZ(a),s.setW(n),s}},THREE.MMDPhysics.RigidBody=function(e,t,r,i){this.mesh=e,this.world=t,this.params=r,this.helper=i,this.body=null,this.bone=null,this.boneOffsetForm=null,this.boneOffsetFormInverse=null,this.init()},THREE.MMDPhysics.RigidBody.prototype={constructor:THREE.MMDPhysics.RigidBody,init:function(){function e(e){switch(e.shapeType){case 0:return new Ammo.btSphereShape(e.width);case 1:return new Ammo.btBoxShape(new Ammo.btVector3(e.width,e.height,e.depth));case 2:return new Ammo.btCapsuleShape(e.width,e.height);default:throw"unknown shape type "+e.shapeType}}var t=this.helper,r=this.params,i=this.mesh.skeleton.bones,a=r.boneIndex===-1?new THREE.Bone:i[r.boneIndex],n=e(r),o=0===r.type?0:r.weight,s=t.allocVector3();s.setValue(0,0,0),0!==o&&n.calculateLocalInertia(o,s);var l=t.allocTransform();t.setIdentity(l),t.setOriginFromArray3(l,r.position),t.setBasisFromArray3(l,r.rotation);var u=t.allocTransform();t.setIdentity(u),t.setOriginFromArray3(u,a.getWorldPosition().toArray());var h=t.multiplyTransforms(u,l),d=new Ammo.btDefaultMotionState(h),f=new Ammo.btRigidBodyConstructionInfo(o,d,n,s);f.set_m_friction(r.friction),f.set_m_restitution(r.restitution);var c=new Ammo.btRigidBody(f);0===r.type&&(c.setCollisionFlags(2|c.getCollisionFlags()),c.setActivationState(4)),c.setDamping(r.positionDamping,r.rotationDamping),c.setSleepingThresholds(0,0),this.world.addRigidBody(c,1<<r.groupIndex,r.groupTarget),this.body=c,this.bone=a,this.boneOffsetForm=l,this.boneOffsetFormInverse=t.inverseTransform(l),t.freeVector3(s),t.freeTransform(h),t.freeTransform(u)},reset:function(){this.setTransformFromBone()},updateFromBone:function(){this.params.boneIndex!==-1&&0===this.params.type&&this.setTransformFromBone()},updateBone:function(){0!==this.params.type&&this.params.boneIndex!==-1&&(this.updateBoneRotation(),1===this.params.type&&this.updateBonePosition(),this.bone.updateMatrixWorld(!0),2===this.params.type&&this.setPositionFromBone())},getBoneTransform:function(){var e=this.helper,t=this.bone.getWorldPosition(),r=this.bone.getWorldQuaternion(),i=e.allocTransform();e.setOriginFromArray3(i,t.toArray()),e.setBasisFromArray4(i,r.toArray());var a=e.multiplyTransforms(i,this.boneOffsetForm);return e.freeTransform(i),a},getWorldTransformForBone:function(){var e=this.helper,t=e.allocTransform();this.body.getMotionState().getWorldTransform(t);var r=e.multiplyTransforms(t,this.boneOffsetFormInverse);return e.freeTransform(t),r},setTransformFromBone:function(){var e=this.helper,t=this.getBoneTransform();this.body.setCenterOfMassTransform(t),this.body.getMotionState().setWorldTransform(t),e.freeTransform(t)},setPositionFromBone:function(){var e=this.helper,t=this.getBoneTransform(),r=e.allocTransform();this.body.getMotionState().getWorldTransform(r),e.copyOrigin(r,t),this.body.setCenterOfMassTransform(r),this.body.getMotionState().setWorldTransform(r),e.freeTransform(r),e.freeTransform(t)},updateBoneRotation:function(){this.bone.updateMatrixWorld(!0);var e=this.helper,t=this.getWorldTransformForBone(),r=e.getBasis(t),i=e.allocThreeQuaternion(),a=e.allocThreeQuaternion(),n=e.allocThreeQuaternion();i.set(r.x(),r.y(),r.z(),r.w()),a.setFromRotationMatrix(this.bone.matrixWorld),a.conjugate(),a.multiply(i),n.setFromRotationMatrix(this.bone.matrix),this.bone.quaternion.copy(a.multiply(n)),e.freeThreeQuaternion(i),e.freeThreeQuaternion(a),e.freeThreeQuaternion(n),e.freeQuaternion(r),e.freeTransform(t)},updateBonePosition:function(){var e=this.helper,t=this.getWorldTransformForBone(),r=e.allocThreeVector3(),i=e.getOrigin(t);r.set(i.x(),i.y(),i.z());var a=this.bone.worldToLocal(r);this.bone.position.add(a),e.freeThreeVector3(r),e.freeTransform(t)}},THREE.MMDPhysics.Constraint=function(e,t,r,i,a,n){this.mesh=e,this.world=t,this.bodyA=r,this.bodyB=i,this.params=a,this.helper=n,this.constraint=null,this.init()},THREE.MMDPhysics.Constraint.prototype={constructor:THREE.MMDPhysics.Constraint,init:function(){var e=this.helper,t=this.params,r=this.bodyA,i=this.bodyB,a=e.allocTransform();e.setIdentity(a),e.setOriginFromArray3(a,t.position),e.setBasisFromArray3(a,t.rotation);var n=e.allocTransform(),o=e.allocTransform();r.body.getMotionState().getWorldTransform(n),i.body.getMotionState().getWorldTransform(o);var s=e.inverseTransform(n),l=e.inverseTransform(o),u=e.multiplyTransforms(s,a),h=e.multiplyTransforms(l,a),d=new Ammo.btGeneric6DofSpringConstraint(r.body,i.body,u,h,!0),f=e.allocVector3(),c=e.allocVector3(),m=e.allocVector3(),p=e.allocVector3();f.setValue(t.translationLimitation1[0],t.translationLimitation1[1],t.translationLimitation1[2]),c.setValue(t.translationLimitation2[0],t.translationLimitation2[1],t.translationLimitation2[2]),m.setValue(t.rotationLimitation1[0],t.rotationLimitation1[1],t.rotationLimitation1[2]),p.setValue(t.rotationLimitation2[0],t.rotationLimitation2[1],t.rotationLimitation2[2]),d.setLinearLowerLimit(f),d.setLinearUpperLimit(c),d.setAngularLowerLimit(m),d.setAngularUpperLimit(p);for(var g=0;g<3;g++)0!==t.springPosition[g]&&(d.enableSpring(g,!0),d.setStiffness(g,t.springPosition[g]));for(var g=0;g<3;g++)0!==t.springRotation[g]&&(d.enableSpring(g+3,!0),d.setStiffness(g+3,t.springRotation[g]));if(void 0!==d.setParam)for(var g=0;g<6;g++)d.setParam(2,.475,g);this.world.addConstraint(d,!0),this.constraint=d,e.freeTransform(a),e.freeTransform(n),e.freeTransform(o),e.freeTransform(s),e.freeTransform(l),e.freeTransform(u),e.freeTransform(h),e.freeVector3(f),e.freeVector3(c),e.freeVector3(m),e.freeVector3(p)}},THREE.MMDPhysicsHelper=function(e){if(void 0===e.physics||void 0===e.geometry.rigidBodies)throw"THREE.MMDPhysicsHelper requires physics in mesh and rigidBodies in mesh.geometry.";THREE.Object3D.call(this),this.root=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.materials=[],this.materials.push(new THREE.MeshBasicMaterial({color:new THREE.Color(16746632),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this.materials.push(new THREE.MeshBasicMaterial({color:new THREE.Color(8978312),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this.materials.push(new THREE.MeshBasicMaterial({color:new THREE.Color(8947967),wireframe:!0,depthTest:!1,depthWrite:!1,opacity:.25,transparent:!0})),this._init(),this.update()},THREE.MMDPhysicsHelper.prototype=Object.create(THREE.Object3D.prototype),THREE.MMDPhysicsHelper.prototype.constructor=THREE.MMDPhysicsHelper,THREE.MMDPhysicsHelper.prototype._init=function(){function e(e){switch(e.shapeType){case 0:return new THREE.SphereBufferGeometry(e.width,16,8);case 1:return new THREE.BoxBufferGeometry(2*e.width,2*e.height,2*e.depth,8,8,8);case 2:return new t(e.width,e.height,16,8);default:return null}}function t(e,t,r,i){var a=new THREE.CylinderBufferGeometry(e,e,t,r,i,!0),n=new THREE.Mesh(new THREE.SphereBufferGeometry(e,r,i,0,2*Math.PI,0,Math.PI/2)),o=new THREE.Mesh(new THREE.SphereBufferGeometry(e,r,i,0,2*Math.PI,Math.PI/2,Math.PI/2));return n.position.set(0,t/2,0),o.position.set(0,-t/2,0),n.updateMatrix(),o.updateMatrix(),a.merge(n.geometry,n.matrix),a.merge(o.geometry,o.matrix),a}for(var r=this.root,i=r.geometry.rigidBodies,a=0,n=i.length;a<n;a++){var o=i[a];this.add(new THREE.Mesh(e(o),this.materials[o.type]))}},THREE.MMDPhysicsHelper.prototype.update=function(){function e(e){return o.set(e.x(),e.y(),e.z()),o.applyMatrix4(n),o}function t(e){return s.set(e.x(),e.y(),e.z(),e.w()),l.setFromRotationMatrix(n),l.multiply(s),l}for(var r=this.root,i=r.geometry.rigidBodies,a=r.physics.bodies,n=(new THREE.Matrix4).getInverse(r.matrixWorld),o=new THREE.Vector3,s=new THREE.Quaternion,l=new THREE.Quaternion,u=0,h=i.length;u<h;u++){var d=a[u].body,r=this.children[u],f=d.getCenterOfMassTransform();r.position.copy(e(f.getOrigin())),r.quaternion.copy(t(f.getRotation()))}}},function(e,t){THREE.OutlineEffect=function(e,t){function r(e){var t,r,i=y[e.type];e.outlineParameters;if(void 0!==i){var a=THREE.ShaderLib[i];t=a.uniforms,r=a.vertexShader}else{if(e.isShaderMaterial!==!0)return A;t=e.uniforms,r=e.vertexShader}var n=Object.assign({},t,T),o=r.replace(/void\s+main\s*\(\s*\)/,M+"\nvoid main()").replace(/\}\s*$/,R+"\n}").replace(/#include\s+<[\w_]*light[\w_]*>/g,""),s=new THREE.ShaderMaterial({uniforms:n,vertexShader:o,fragmentShader:x,side:THREE.BackSide,skinning:!1,morphTargets:!1,morphNormals:!1,fog:!1});return s}function i(e){for(var t=[],i=0,a=e.materials.length;i<a;i++)t.push(r(e.materials[i]));return new THREE.MultiMaterial(t)}function a(e){if(void 0!==e.material){var t=p[e.material.uuid];void 0===t&&(t={material:e.material.isMultiMaterial===!0?i(e.material):r(e.material),used:!0,keepAlive:m,count:0},p[e.material.uuid]=t);var a=t.material;t.used=!0;var n=a!==A?a.uuid:e.uuid;if(v[n]=e.material,e.material.isMultiMaterial===!0){for(var s=0,h=e.material.materials.length;s<h;s++)a.materials[s]!==A&&(v[a.materials[s].uuid]=e.material.materials[s]);u(a,e.material)}else l(a,e.material);e.material=a,E[e.uuid]=e.onBeforeRender,e.onBeforeRender=o}}function n(e){if(void 0!==e.material){var t=v[e.material.uuid];void 0===t&&(t=v[e.uuid],void 0===t)||(e.material=t,e.onBeforeRender=E[e.uuid])}}function o(e,t,r,i,a,n){if(a!==A&&a.isMultiMaterial!==!0){var o=v[a.uuid];void 0!==o&&s(a,o)}}function s(e,t){var r=t.outlineParameters;e.uniforms.outlineAlpha.value=t.opacity,void 0!==r&&(void 0!==r.thickness&&(e.uniforms.outlineThickness.value=r.thickness),void 0!==r.color&&e.uniforms.outlineColor.value.copy(r.color),void 0!==r.alpha&&(e.uniforms.outlineAlpha.value=r.alpha))}function l(e,t){if(e!==A){var r=t.outlineParameters;e.skinning=t.skinning,e.morphTargets=t.morphTargets,e.morphNormals=t.morphNormals,e.fog=t.fog,void 0!==r?(t.visible===!1?e.visible=!1:e.visible=void 0===r.visible||r.visible,e.transparent=void 0!==r.alpha&&r.alpha<1||t.transparent,void 0!==r.keepAlive&&void 0!==p[t.uuid]&&(p[t.uuid].keepAlive=r.keepAlive)):(e.transparent=t.transparent,e.visible=t.visible),t.wireframe!==!0&&t.depthTest!==!1||(e.visible=!1)}}function u(e,t){if(e!==A){var r=t.outlineParameters;void 0!==r?(t.visible===!1?e.visible=!1:e.visible=void 0===r.visible||r.visible,void 0!==r.keepAlive&&(p[t.uuid].keepAlive=r.keepAlive)):e.visible=t.visible;for(var i=0,a=e.materials.length;i<a;i++)l(e.materials[i],t.materials[i])}}function h(){var e;e=Object.keys(v);for(var t=0,r=e.length;t<r;t++)v[e[t]]=void 0;e=Object.keys(E);for(var t=0,r=e.length;t<r;t++)E[e[t]]=void 0;e=Object.keys(p);for(var t=0,r=e.length;t<r;t++){var i=e[t];p[i].used===!1?(p[i].count++,p[i].keepAlive===!1&&p[i].count>g&&delete p[i]):(p[i].used=!1,p[i].count=0)}}t=t||{},this.autoClear=void 0===t.autoClear||t.autoClear;var d=void 0!==t.defaultThickness?t.defaultThickness:.003,f=void 0!==t.defaultColor?t.defaultColor:new THREE.Color(0),c=void 0!==t.defaultAlpha?t.defaultAlpha:1,m=void 0!==t.defaultKeepAlive&&t.defaultKeepAlive,p={},g=60,v={},E={},A=new THREE.ShaderMaterial({visible:!1}),y={MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical"},T={outlineThickness:{type:"f",value:d},outlineColor:{type:"c",value:f},outlineAlpha:{type:"f",value:c}},M=["uniform float outlineThickness;","vec4 calculateOutline( vec4 pos, vec3 objectNormal, vec4 skinned ) {","\tfloat thickness = outlineThickness;","\tfloat ratio = 1.0;","\tvec4 pos2 = projectionMatrix * modelViewMatrix * vec4( skinned.xyz + objectNormal, 1.0 );","\tvec4 norm = normalize( pos - pos2 );","\treturn pos + norm * thickness * pos.w * ratio;","}"].join("\n"),R=["#if ! defined( LAMBERT ) && ! defined( PHONG ) && ! defined( PHYSICAL )","\t#ifndef USE_ENVMAP","\t\tvec3 objectNormal = normalize( normal );","\t\t#ifdef FLIP_SIDED","\t\t\tobjectNormal = -objectNormal;","\t\t#endif","\t#endif","#endif","#ifdef USE_SKINNING","\tgl_Position = calculateOutline( gl_Position, objectNormal, skinned );","#else","\tgl_Position = calculateOutline( gl_Position, objectNormal, vec4( transformed, 1.0 ) );","#endif"].join("\n"),x=["#include <common>","#include <fog_pars_fragment>","uniform vec3 outlineColor;","uniform float outlineAlpha;","void main() {","\tgl_FragColor = vec4( outlineColor, outlineAlpha );","\t#include <fog_fragment>","}"].join("\n");this.setSize=function(t,r){e.setSize(t,r)},this.render=function(t,r,i,o){var s=e.autoClear;e.autoClear=this.autoClear,e.render(t,r,i,o);var l=t.autoUpdate,u=t.background,d=e.shadowMap.enabled;t.autoUpdate=!1,t.background=null,e.autoClear=!1,e.shadowMap.enabled=!1,t.traverse(a),e.render(t,r,i),t.traverse(n),h(),t.autoUpdate=l,t.background=u,e.autoClear=s,e.shadowMap.enabled=d}}},function(e,t){THREE.MMDLoader=function(e){THREE.Loader.call(this),this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.MMDLoader.prototype=Object.create(THREE.Loader.prototype),THREE.MMDLoader.prototype.constructor=THREE.MMDLoader,THREE.MMDLoader.prototype.defaultToonTextures=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="],THREE.MMDLoader.prototype.load=function(e,t,r,i,a){var n=this;this.loadModel(e,function(e){n.loadVmds(t,function(t){n.pourVmdIntoModel(e,t),r(e)},i,a)},i,a)},THREE.MMDLoader.prototype.loadModel=function(e,t,r,i){var a=this,n=this.extractUrlBase(e),o=this.extractExtension(e);this.loadFileAsBuffer(e,function(e){t(a.createModel(e,o,n))},r,i)},
THREE.MMDLoader.prototype.createModel=function(e,t,r){return this.createMesh(this.parseModel(e,t),r)},THREE.MMDLoader.prototype.loadVmd=function(e,t,r,i){var a=this;this.loadFileAsBuffer(e,function(e){t(a.parseVmd(e))},r,i)},THREE.MMDLoader.prototype.loadVmds=function(e,t,r,i){function a(){var s=e.shift();n.loadVmd(s,function(r){o.push(r),e.length>0?a():t(n.mergeVmds(o))},r,i)}var n=this,o=[];a()},THREE.MMDLoader.prototype.loadAudio=function(e,t,r,i){var a=new THREE.AudioListener,n=new THREE.Audio(a),o=new THREE.AudioLoader(this.manager);o.load(e,function(e){n.setBuffer(e),t(n,a)},r,i)},THREE.MMDLoader.prototype.loadVpd=function(e,t,r,i,a){var n=this,o=(a&&"unicode"===a.charcode?this.loadFileAsText:this.loadFileAsShiftJISText).bind(this);o(e,function(e){t(n.parseVpd(e))},r,i)},THREE.MMDLoader.prototype.mergeVmds=function(e){var t={};t.metadata={},t.metadata.name=e[0].metadata.name,t.metadata.coordinateSystem=e[0].metadata.coordinateSystem,t.metadata.motionCount=0,t.metadata.morphCount=0,t.metadata.cameraCount=0,t.motions=[],t.morphs=[],t.cameras=[];for(var r=0;r<e.length;r++){var i=e[r];t.metadata.motionCount+=i.metadata.motionCount,t.metadata.morphCount+=i.metadata.morphCount,t.metadata.cameraCount+=i.metadata.cameraCount;for(var a=0;a<i.metadata.motionCount;a++)t.motions.push(i.motions[a]);for(var a=0;a<i.metadata.morphCount;a++)t.morphs.push(i.morphs[a]);for(var a=0;a<i.metadata.cameraCount;a++)t.cameras.push(i.cameras[a])}return t},THREE.MMDLoader.prototype.pourVmdIntoModel=function(e,t,r){this.createAnimation(e,t,r)},THREE.MMDLoader.prototype.pourVmdIntoCamera=function(e,t,r){var i=new THREE.MMDLoader.DataCreationHelper,a=function(){for(var a=i.createOrderedMotionArray(t.cameras),n=[],o=[],s=[],l=[],u=[],h=[],d=[],f=[],c=[],m=new THREE.Quaternion,p=new THREE.Euler,g=new THREE.Vector3,v=new THREE.Vector3,E=function(e,t){e.push(t.x),e.push(t.y),e.push(t.z)},A=function(e,t){e.push(t.x),e.push(t.y),e.push(t.z),e.push(t.w)},y=function(e,t,r){e.push(t[4*r+0]/127),e.push(t[4*r+1]/127),e.push(t[4*r+2]/127),e.push(t[4*r+3]/127)},T=function(e,t,r,i,a){if(r.length>2){r=r.slice(),i=i.slice(),a=a.slice();var n=i.length/r.length,o=3===n?12:4,s=2,l=1;for(s=2,endIndex=r.length;s<endIndex;s++){for(var u=0;u<n;u++)if(i[l*n+u]!==i[(l-1)*n+u]||i[l*n+u]!==i[s*n+u]){l++;break}if(s>l){r[l]=r[s];for(var u=0;u<n;u++)i[l*n+u]=i[s*n+u];for(var u=0;u<o;u++)a[l*o+u]=a[s*o+u]}}r.length=l+1,i.length=(l+1)*n,a.length=(l+1)*o}return new THREE.MMDLoader[t](e,r,i,a)},M=0;M<a.length;M++){var R=a[M],x=R.frameNum/30,b=R.position,C=R.rotation,H=R.distance,w=R.fov,I=R.interpolation;g.set(0,0,-H),v.set(b[0],b[1],b[2]),p.set(-C[0],-C[1],-C[2]),m.setFromEuler(p),g.add(v),g.applyQuaternion(m),n.length>0&&x<n[n.length-1]+.05&&(n[n.length-1]=x-1e-13),n.push(x),E(o,v),A(s,m),E(l,g),u.push(w);for(var B=0;B<3;B++)y(h,I,B);y(d,I,3);for(var B=0;B<3;B++)y(f,I,4);y(c,I,5)}if(0!==n.length){var k=[];k.push(T(".center","VectorKeyframeTrackEx",n,o,h)),k.push(T(".quaternion","QuaternionKeyframeTrackEx",n,s,d)),k.push(T(".position","VectorKeyframeTrackEx",n,l,f)),k.push(T(".fov","NumberKeyframeTrackEx",n,u,c));var S=new THREE.AnimationClip(void 0===r?THREE.Math.generateUUID():r,-1,k);null!==S&&(void 0===e.center&&(e.center=new THREE.Vector3(0,0,0)),void 0===e.animations&&(e.animations=[]),e.animations.push(S))}};this.leftToRightVmd(t),a()},THREE.MMDLoader.prototype.extractExtension=function(e){var t=e.lastIndexOf(".");return t<0?null:e.slice(t+1)},THREE.MMDLoader.prototype.loadFile=function(e,t,r,i,a,n){var o=new THREE.FileLoader(this.manager);void 0!==n&&o.setMimeType(n),o.setResponseType(a);var s=o.load(e,function(e){t(e)},r,i);return s},THREE.MMDLoader.prototype.loadFileAsBuffer=function(e,t,r,i){this.loadFile(e,t,r,i,"arraybuffer")},THREE.MMDLoader.prototype.loadFileAsText=function(e,t,r,i){this.loadFile(e,t,r,i,"text")},THREE.MMDLoader.prototype.loadFileAsShiftJISText=function(e,t,r,i){this.loadFile(e,t,r,i,"text","text/plain; charset=shift_jis")},THREE.MMDLoader.prototype.parseModel=function(e,t){switch(t.toLowerCase()){case"pmd":return this.parsePmd(e);case"pmx":return this.parsePmx(e);default:throw"extension "+t+" is not supported."}},THREE.MMDLoader.prototype.parsePmd=function(e){var t={},r=new THREE.MMDLoader.DataView(e);new THREE.MMDLoader.DataCreationHelper;t.metadata={},t.metadata.format="pmd",t.metadata.coordinateSystem="left";var i=function(){var e=t.metadata;if(e.magic=r.getChars(3),"Pmd"!==e.magic)throw"PMD file magic is not Pmd, but "+e.magic;e.version=r.getFloat32(),e.modelName=r.getSjisStringsAsUnicode(20),e.comment=r.getSjisStringsAsUnicode(256)},a=function(){var e=function(){var e={};return e.position=r.getFloat32Array(3),e.normal=r.getFloat32Array(3),e.uv=r.getFloat32Array(2),e.skinIndices=r.getUint16Array(2),e.skinWeights=[r.getUint8()/100],e.skinWeights.push(1-e.skinWeights[0]),e.edgeFlag=r.getUint8(),e},i=t.metadata;i.vertexCount=r.getUint32(),t.vertices=[];for(var a=0;a<i.vertexCount;a++)t.vertices.push(e())},n=function(){var e=function(){var e={};return e.indices=r.getUint16Array(3),e},i=t.metadata;i.faceCount=r.getUint32()/3,t.faces=[];for(var a=0;a<i.faceCount;a++)t.faces.push(e())},o=function(){var e=function(){var e={};return e.diffuse=r.getFloat32Array(4),e.shininess=r.getFloat32(),e.specular=r.getFloat32Array(3),e.ambient=r.getFloat32Array(3),e.toonIndex=r.getInt8(),e.edgeFlag=r.getUint8(),e.faceCount=r.getUint32()/3,e.fileName=r.getSjisStringsAsUnicode(20),e},i=t.metadata;i.materialCount=r.getUint32(),t.materials=[];for(var a=0;a<i.materialCount;a++)t.materials.push(e())},s=function(){var e=function(){var e={};return e.name=r.getSjisStringsAsUnicode(20),e.parentIndex=r.getInt16(),e.tailIndex=r.getInt16(),e.type=r.getUint8(),e.ikIndex=r.getInt16(),e.position=r.getFloat32Array(3),e},i=t.metadata;i.boneCount=r.getUint16(),t.bones=[];for(var a=0;a<i.boneCount;a++)t.bones.push(e())},l=function(){var e=function(){var e={};e.target=r.getUint16(),e.effector=r.getUint16(),e.linkCount=r.getUint8(),e.iteration=r.getUint16(),e.maxAngle=r.getFloat32(),e.links=[];for(var t=0;t<e.linkCount;t++){var i={};i.index=r.getUint16(),e.links.push(i)}return e},i=t.metadata;i.ikCount=r.getUint16(),t.iks=[];for(var a=0;a<i.ikCount;a++)t.iks.push(e())},u=function(){var e=function(){var e={};e.name=r.getSjisStringsAsUnicode(20),e.elementCount=r.getUint32(),e.type=r.getUint8(),e.elements=[];for(var t=0;t<e.elementCount;t++)e.elements.push({index:r.getUint32(),position:r.getFloat32Array(3)});return e},i=t.metadata;i.morphCount=r.getUint16(),t.morphs=[];for(var a=0;a<i.morphCount;a++)t.morphs.push(e())},h=function(){var e=function(){var e={};return e.index=r.getUint16(),e},i=t.metadata;i.morphFrameCount=r.getUint8(),t.morphFrames=[];for(var a=0;a<i.morphFrameCount;a++)t.morphFrames.push(e())},d=function(){var e=function(){var e={};return e.name=r.getSjisStringsAsUnicode(50),e},i=t.metadata;i.boneFrameNameCount=r.getUint8(),t.boneFrameNames=[];for(var a=0;a<i.boneFrameNameCount;a++)t.boneFrameNames.push(e())},f=function(){var e=function(){var e={};return e.boneIndex=r.getInt16(),e.frameIndex=r.getUint8(),e},i=t.metadata;i.boneFrameCount=r.getUint32(),t.boneFrames=[];for(var a=0;a<i.boneFrameCount;a++)t.boneFrames.push(e())},c=function(){var e=t.metadata;e.englishCompatibility=r.getUint8(),e.englishCompatibility>0&&(e.englishModelName=r.getSjisStringsAsUnicode(20),e.englishComment=r.getSjisStringsAsUnicode(256))},m=function(){var e=function(){var e={};return e.name=r.getSjisStringsAsUnicode(20),e},i=t.metadata;if(0!==i.englishCompatibility){t.englishBoneNames=[];for(var a=0;a<i.boneCount;a++)t.englishBoneNames.push(e())}},p=function(){var e=function(){var e={};return e.name=r.getSjisStringsAsUnicode(20),e},i=t.metadata;if(0!==i.englishCompatibility){t.englishMorphNames=[];for(var a=0;a<i.morphCount-1;a++)t.englishMorphNames.push(e())}},g=function(){var e=function(){var e={};return e.name=r.getSjisStringsAsUnicode(50),e},i=t.metadata;if(0!==i.englishCompatibility){t.englishBoneFrameNames=[];for(var a=0;a<i.boneFrameNameCount;a++)t.englishBoneFrameNames.push(e())}},v=function(){var e=function(){var e={};return e.fileName=r.getSjisStringsAsUnicode(100),e};t.toonTextures=[];for(var i=0;i<10;i++)t.toonTextures.push(e())},E=function(){var e=function(){var e={};return e.name=r.getSjisStringsAsUnicode(20),e.boneIndex=r.getInt16(),e.groupIndex=r.getUint8(),e.groupTarget=r.getUint16(),e.shapeType=r.getUint8(),e.width=r.getFloat32(),e.height=r.getFloat32(),e.depth=r.getFloat32(),e.position=r.getFloat32Array(3),e.rotation=r.getFloat32Array(3),e.weight=r.getFloat32(),e.positionDamping=r.getFloat32(),e.rotationDamping=r.getFloat32(),e.restitution=r.getFloat32(),e.friction=r.getFloat32(),e.type=r.getUint8(),e},i=t.metadata;i.rigidBodyCount=r.getUint32(),t.rigidBodies=[];for(var a=0;a<i.rigidBodyCount;a++)t.rigidBodies.push(e())},A=function(){var e=function(){var e={};return e.name=r.getSjisStringsAsUnicode(20),e.rigidBodyIndex1=r.getUint32(),e.rigidBodyIndex2=r.getUint32(),e.position=r.getFloat32Array(3),e.rotation=r.getFloat32Array(3),e.translationLimitation1=r.getFloat32Array(3),e.translationLimitation2=r.getFloat32Array(3),e.rotationLimitation1=r.getFloat32Array(3),e.rotationLimitation2=r.getFloat32Array(3),e.springPosition=r.getFloat32Array(3),e.springRotation=r.getFloat32Array(3),e},i=t.metadata;i.constraintCount=r.getUint32(),t.constraints=[];for(var a=0;a<i.constraintCount;a++)t.constraints.push(e())};return i(),a(),n(),o(),s(),l(),u(),h(),d(),f(),c(),m(),p(),g(),v(),E(),A(),t},THREE.MMDLoader.prototype.parsePmx=function(e){var t={},r=new THREE.MMDLoader.DataView(e);new THREE.MMDLoader.DataCreationHelper;t.metadata={},t.metadata.format="pmx",t.metadata.coordinateSystem="left";var i=function(){var e=t.metadata;if(e.magic=r.getChars(4),"PMX "!==e.magic)throw"PMX file magic is not PMX , but "+e.magic;if(e.version=r.getFloat32(),2!==e.version&&2.1!==e.version)throw"PMX version "+e.version+" is not supported.";e.headerSize=r.getUint8(),e.encoding=r.getUint8(),e.additionalUvNum=r.getUint8(),e.vertexIndexSize=r.getUint8(),e.textureIndexSize=r.getUint8(),e.materialIndexSize=r.getUint8(),e.boneIndexSize=r.getUint8(),e.morphIndexSize=r.getUint8(),e.rigidBodyIndexSize=r.getUint8(),e.modelName=r.getTextBuffer(),e.englishModelName=r.getTextBuffer(),e.comment=r.getTextBuffer(),e.englishComment=r.getTextBuffer()},a=function(){var e=function(){var e={};e.position=r.getFloat32Array(3),e.normal=r.getFloat32Array(3),e.uv=r.getFloat32Array(2),e.auvs=[];for(var a=0;a<t.metadata.additionalUvNum;a++)e.auvs.push(r.getFloat32Array(4));e.type=r.getUint8();var n=i.boneIndexSize;if(0===e.type)e.skinIndices=r.getIndexArray(n,1),e.skinWeights=[1];else if(1===e.type)e.skinIndices=r.getIndexArray(n,2),e.skinWeights=r.getFloat32Array(1),e.skinWeights.push(1-e.skinWeights[0]);else if(2===e.type)e.skinIndices=r.getIndexArray(n,4),e.skinWeights=r.getFloat32Array(4);else{if(3!==e.type)throw"unsupport bone type "+e.type+" exception.";e.skinIndices=r.getIndexArray(n,2),e.skinWeights=r.getFloat32Array(1),e.skinWeights.push(1-e.skinWeights[0]),e.skinC=r.getFloat32Array(3),e.skinR0=r.getFloat32Array(3),e.skinR1=r.getFloat32Array(3),e.type=1}return e.edgeRatio=r.getFloat32(),e},i=t.metadata;i.vertexCount=r.getUint32(),t.vertices=[];for(var a=0;a<i.vertexCount;a++)t.vertices.push(e())},n=function(){var e=function(){var e={};return e.indices=r.getIndexArray(i.vertexIndexSize,3,!0),e},i=t.metadata;i.faceCount=r.getUint32()/3,t.faces=[];for(var a=0;a<i.faceCount;a++)t.faces.push(e())},o=function(){var e=function(){return r.getTextBuffer()},i=t.metadata;i.textureCount=r.getUint32(),t.textures=[];for(var a=0;a<i.textureCount;a++)t.textures.push(e())},s=function(){var e=function(){var e={};if(e.name=r.getTextBuffer(),e.englishName=r.getTextBuffer(),e.diffuse=r.getFloat32Array(4),e.specular=r.getFloat32Array(3),e.shininess=r.getFloat32(),e.ambient=r.getFloat32Array(3),e.flag=r.getUint8(),e.edgeColor=r.getFloat32Array(4),e.edgeSize=r.getFloat32(),e.textureIndex=r.getIndex(t.metadata.textureIndexSize),e.envTextureIndex=r.getIndex(t.metadata.textureIndexSize),e.envFlag=r.getUint8(),e.toonFlag=r.getUint8(),0===e.toonFlag)e.toonIndex=r.getIndex(t.metadata.textureIndexSize);else{if(1!==e.toonFlag)throw"unknown toon flag "+e.toonFlag+" exception.";e.toonIndex=r.getInt8()}return e.comment=r.getTextBuffer(),e.faceCount=r.getUint32()/3,e},i=t.metadata;i.materialCount=r.getUint32(),t.materials=[];for(var a=0;a<i.materialCount;a++)t.materials.push(e())},l=function(){var e=function(){var e={};if(e.name=r.getTextBuffer(),e.englishName=r.getTextBuffer(),e.position=r.getFloat32Array(3),e.parentIndex=r.getIndex(t.metadata.boneIndexSize),e.transformationClass=r.getUint32(),e.flag=r.getUint16(),1&e.flag?e.connectIndex=r.getIndex(t.metadata.boneIndexSize):e.offsetPosition=r.getFloat32Array(3),256&e.flag||512&e.flag){var i={};i.isLocal=0!==(128&e.flag),i.affectRotation=0!==(256&e.flag),i.affectPosition=0!==(512&e.flag),i.parentIndex=r.getIndex(t.metadata.boneIndexSize),i.ratio=r.getFloat32(),e.grant=i}if(1024&e.flag&&(e.fixAxis=r.getFloat32Array(3)),2048&e.flag&&(e.localXVector=r.getFloat32Array(3),e.localZVector=r.getFloat32Array(3)),8192&e.flag&&(e.key=r.getUint32()),32&e.flag){var a={};a.effector=r.getIndex(t.metadata.boneIndexSize),a.target=null,a.iteration=r.getUint32(),a.maxAngle=r.getFloat32(),a.linkCount=r.getUint32(),a.links=[];for(var n=0;n<a.linkCount;n++){var o={};o.index=r.getIndex(t.metadata.boneIndexSize),o.angleLimitation=r.getUint8(),1===o.angleLimitation&&(o.lowerLimitationAngle=r.getFloat32Array(3),o.upperLimitationAngle=r.getFloat32Array(3)),a.links.push(o)}e.ik=a}return e},i=t.metadata;i.boneCount=r.getUint32(),t.bones=[];for(var a=0;a<i.boneCount;a++)t.bones.push(e())},u=function(){var e=function(){var e={};e.name=r.getTextBuffer(),e.englishName=r.getTextBuffer(),e.panel=r.getUint8(),e.type=r.getUint8(),e.elementCount=r.getUint32(),e.elements=[];for(var i=0;i<e.elementCount;i++)if(0===e.type){var a={};a.index=r.getIndex(t.metadata.morphIndexSize),a.ratio=r.getFloat32(),e.elements.push(a)}else if(1===e.type){var a={};a.index=r.getIndex(t.metadata.vertexIndexSize,!0),a.position=r.getFloat32Array(3),e.elements.push(a)}else if(2===e.type){var a={};a.index=r.getIndex(t.metadata.boneIndexSize),a.position=r.getFloat32Array(3),a.rotation=r.getFloat32Array(4),e.elements.push(a)}else if(3===e.type){var a={};a.index=r.getIndex(t.metadata.vertexIndexSize,!0),a.uv=r.getFloat32Array(4),e.elements.push(a)}else if(4===e.type);else if(5===e.type);else if(6===e.type);else if(7===e.type);else if(8===e.type){var a={};a.index=r.getIndex(t.metadata.materialIndexSize),a.type=r.getUint8(),a.diffuse=r.getFloat32Array(4),a.specular=r.getFloat32Array(3),a.shininess=r.getFloat32(),a.ambient=r.getFloat32Array(3),a.edgeColor=r.getFloat32Array(4),a.edgeSize=r.getFloat32(),a.textureColor=r.getFloat32Array(4),a.sphereTextureColor=r.getFloat32Array(4),a.toonColor=r.getFloat32Array(4),e.elements.push(a)}return e},i=t.metadata;i.morphCount=r.getUint32(),t.morphs=[];for(var a=0;a<i.morphCount;a++)t.morphs.push(e())},h=function(){var e=function(){var e={};e.name=r.getTextBuffer(),e.englishName=r.getTextBuffer(),e.type=r.getUint8(),e.elementCount=r.getUint32(),e.elements=[];for(var i=0;i<e.elementCount;i++){var a={};a.target=r.getUint8(),a.index=0===a.target?r.getIndex(t.metadata.boneIndexSize):r.getIndex(t.metadata.morphIndexSize),e.elements.push(a)}return e},i=t.metadata;i.frameCount=r.getUint32(),t.frames=[];for(var a=0;a<i.frameCount;a++)t.frames.push(e())},d=function(){var e=function(){var e={};return e.name=r.getTextBuffer(),e.englishName=r.getTextBuffer(),e.boneIndex=r.getIndex(t.metadata.boneIndexSize),e.groupIndex=r.getUint8(),e.groupTarget=r.getUint16(),e.shapeType=r.getUint8(),e.width=r.getFloat32(),e.height=r.getFloat32(),e.depth=r.getFloat32(),e.position=r.getFloat32Array(3),e.rotation=r.getFloat32Array(3),e.weight=r.getFloat32(),e.positionDamping=r.getFloat32(),e.rotationDamping=r.getFloat32(),e.restitution=r.getFloat32(),e.friction=r.getFloat32(),e.type=r.getUint8(),e},i=t.metadata;i.rigidBodyCount=r.getUint32(),t.rigidBodies=[];for(var a=0;a<i.rigidBodyCount;a++)t.rigidBodies.push(e())},f=function(){var e=function(){var e={};return e.name=r.getTextBuffer(),e.englishName=r.getTextBuffer(),e.type=r.getUint8(),e.rigidBodyIndex1=r.getIndex(t.metadata.rigidBodyIndexSize),e.rigidBodyIndex2=r.getIndex(t.metadata.rigidBodyIndexSize),e.position=r.getFloat32Array(3),e.rotation=r.getFloat32Array(3),e.translationLimitation1=r.getFloat32Array(3),e.translationLimitation2=r.getFloat32Array(3),e.rotationLimitation1=r.getFloat32Array(3),e.rotationLimitation2=r.getFloat32Array(3),e.springPosition=r.getFloat32Array(3),e.springRotation=r.getFloat32Array(3),e},i=t.metadata;i.constraintCount=r.getUint32(),t.constraints=[];for(var a=0;a<i.constraintCount;a++)t.constraints.push(e())};return i(),a(),n(),o(),s(),l(),u(),h(),d(),f(),t},THREE.MMDLoader.prototype.parseVmd=function(e){var t={},r=new THREE.MMDLoader.DataView(e);new THREE.MMDLoader.DataCreationHelper;t.metadata={},t.metadata.coordinateSystem="left";var i=function(){var e=t.metadata;if(e.magic=r.getChars(30),"Vocaloid Motion Data 0002"!==e.magic)throw"VMD file magic is not Vocaloid Motion Data 0002, but "+e.magic;e.name=r.getSjisStringsAsUnicode(20)},a=function(){var e=function(){var e={};return e.boneName=r.getSjisStringsAsUnicode(15),e.frameNum=r.getUint32(),e.position=r.getFloat32Array(3),e.rotation=r.getFloat32Array(4),e.interpolation=r.getUint8Array(64),e},i=t.metadata;i.motionCount=r.getUint32(),t.motions=[];for(var a=0;a<i.motionCount;a++)t.motions.push(e())},n=function(){var e=function(){var e={};return e.morphName=r.getSjisStringsAsUnicode(15),e.frameNum=r.getUint32(),e.weight=r.getFloat32(),e},i=t.metadata;i.morphCount=r.getUint32(),t.morphs=[];for(var a=0;a<i.morphCount;a++)t.morphs.push(e())},o=function(){var e=function(){var e={};return e.frameNum=r.getUint32(),e.distance=r.getFloat32(),e.position=r.getFloat32Array(3),e.rotation=r.getFloat32Array(3),e.interpolation=r.getUint8Array(24),e.fov=r.getUint32(),e.perspective=r.getUint8(),e},i=t.metadata;i.cameraCount=r.getUint32(),t.cameras=[];for(var a=0;a<i.cameraCount;a++)t.cameras.push(e())};return i(),a(),n(),o(),t},THREE.MMDLoader.prototype.parseVpd=function(e){function t(){throw"the file seems not vpd file."}function r(){"Vocaloid Pose Data file"!==l[0]&&t()}function i(){l.length<4&&t(),n.metadata.parentFile=l[2],n.metadata.boneCount=parseInt(l[3])}function a(){for(var e=/^\s*(Bone[0-9]+)\s*\{\s*(.*)$/,r=/^\s*(-?[0-9]+\.[0-9]+)\s*,\s*(-?[0-9]+\.[0-9]+)\s*,\s*(-?[0-9]+\.[0-9]+)\s*;/,i=/^\s*(-?[0-9]+\.[0-9]+)\s*,\s*(-?[0-9]+\.[0-9]+)\s*,\s*(-?[0-9]+\.[0-9]+)\s*,\s*(-?[0-9]+\.[0-9]+)\s*;/,a=/^\s*}/,o=n.bones,s=null,u=null,h=null,d=(new CharsetEncoder,4);d<l.length;d++){var f,c=l[d];f=c.match(e),null!==f&&(null!==s&&t(),s=f[2]),f=c.match(r),null!==f&&(null!==u&&t(),u=[parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3])]),f=c.match(i),null!==f&&(null!==h&&t(),h=[parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3]),parseFloat(f[4])]),f=c.match(a),null!==f&&(null!==s&&null!==u&&null!==h||t(),o.push({name:s,translation:u,quaternion:h}),s=null,u=null,h=null)}null===s&&null===u&&null===h||t()}var n=(new THREE.MMDLoader.DataCreationHelper,{});n.metadata={},n.metadata.coordinateSystem="left",n.bones=[];var o=/\/\/\w*(\r|\n|\r\n)/g,s=/\r|\n|\r\n/,l=e.replace(o,"").split(s);return r(),i(),a(),this.leftToRightVpd(n),n},THREE.MMDLoader.prototype.createMesh=function(e,t,r,i){var a=this,n=new THREE.BufferGeometry,o=new THREE.MultiMaterial,s=(new THREE.MMDLoader.DataCreationHelper,{});s.vertices=[],s.uvs=[],s.normals=[],s.skinIndices=[],s.skinWeights=[],s.indices=[];var l=function(){for(var t=0;t<e.metadata.vertexCount;t++){for(var r=e.vertices[t],i=0,a=r.position.length;i<a;i++)s.vertices.push(r.position[i]);for(var i=0,a=r.normal.length;i<a;i++)s.normals.push(r.normal[i]);for(var i=0,a=r.uv.length;i<a;i++)s.uvs.push(r.uv[i]);for(var i=0;i<4;i++)s.skinIndices.push(r.skinIndices.length-1>=i?r.skinIndices[i]:0);for(var i=0;i<4;i++)s.skinWeights.push(r.skinWeights.length-1>=i?r.skinWeights[i]:0)}},u=function(){for(var t=0;t<e.metadata.faceCount;t++)for(var r=e.faces[t],i=0,a=r.indices.length;i<a;i++)s.indices.push(r.indices[i])},h=function(){for(var t=[],r=e.rigidBodies,i={},a=0,o=r.length;a<o;a++){var s=r[a],l=i[s.boneIndex];l=void 0===l?s.type:Math.max(s.type,l),i[s.boneIndex]=l}for(var a=0;a<e.metadata.boneCount;a++){var u={},h=e.bones[a];u.parent=h.parentIndex,u.name=h.name,u.pos=[h.position[0],h.position[1],h.position[2]],u.rotq=[0,0,0,1],u.scl=[1,1,1],u.parent!==-1&&(u.pos[0]-=e.bones[u.parent].position[0],u.pos[1]-=e.bones[u.parent].position[1],u.pos[2]-=e.bones[u.parent].position[2]),u.rigidBodyType=void 0!==i[a]?i[a]:-1,t.push(u)}n.bones=t},d=function(){var t=[];if("pmd"===e.metadata.format)for(var r=0;r<e.metadata.ikCount;r++){var i=e.iks[r],a={};a.target=i.target,a.effector=i.effector,a.iteration=i.iteration,a.maxAngle=4*i.maxAngle,a.links=[];for(var o=0;o<i.links.length;o++){var s={};s.index=i.links[o].index,e.bones[s.index].name.indexOf("ひざ")>=0&&(s.limitation=new THREE.Vector3(1,0,0)),a.links.push(s)}t.push(a)}else for(var r=0;r<e.metadata.boneCount;r++){var l=e.bones[r],i=l.ik;if(void 0!==i){var a={};a.target=r,a.effector=i.effector,a.iteration=i.iteration,a.maxAngle=i.maxAngle,a.links=[];for(var o=0;o<i.links.length;o++){var s={};s.index=i.links[o].index,s.enabled=!0,1===i.links[o].angleLimitation&&(s.limitation=new THREE.Vector3(1,0,0)),a.links.push(s)}t.push(a)}}n.iks=t},f=function(){if("pmd"!==e.metadata.format){for(var t=[],r=0;r<e.metadata.boneCount;r++){var i=e.bones[r],a=i.grant;if(void 0!==a){var o={};o.index=r,o.parentIndex=a.parentIndex,o.ratio=a.ratio,o.isLocal=a.isLocal,o.affectRotation=a.affectRotation,o.affectPosition=a.affectPosition,o.transformationClass=i.transformationClass,t.push(o)}}t.sort(function(e,t){return e.transformationClass-t.transformationClass}),n.grants=t}},c=function(){function t(e,t,r,i){e.array[3*t+0]+=r.position[0]*i,e.array[3*t+1]+=r.position[1]*i,e.array[3*t+2]+=r.position[2]*i}function r(r,i,a){for(var n=0;n<i.elementCount;n++){var o,s=i.elements[n];o="pmd"===e.metadata.format?e.morphs[0].elements[s.index].index:s.index,t(r,o,s,a)}}for(var i=[],a=[],o=0;o<e.metadata.morphCount;o++){for(var l=e.morphs[o],u={name:l.name},h=new THREE.Float32BufferAttribute(3*e.metadata.vertexCount,3),d=0;d<3*e.metadata.vertexCount;d++)h.array[d]=s.vertices[d];if("pmd"===e.metadata.format)0!==o&&r(h,l,1);else if(0===l.type)for(var d=0;d<l.elementCount;d++){var f=e.morphs[l.elements[d].index],c=l.elements[d].ratio;1===f.type&&r(h,f,c)}else 1===l.type?r(h,l,1):2===l.type||3===l.type||4===l.type||5===l.type||6===l.type||7===l.type||8===l.type;i.push(u),a.push(h)}n.morphTargets=i,n.morphAttributes.position=a},m=function(){function r(e,r){void 0===r&&(r={});var i;if(r.defaultTexturePath===!0)try{i=a.defaultToonTextures[parseInt(e.match("toon([0-9]{2}).bmp$")[1])]}catch(t){console.warn("THREE.MMDLoader: "+e+" seems like not right default texture path. Using toon00.bmp instead."),i=a.defaultToonTextures[0]}else i=t+e;var n=THREE.Loader.Handlers.get(i);null===n&&(n=e.indexOf(".tga")>=0?f:d);var o=n.load(i,function(e){e.flipY=!1,e.wrapS=THREE.RepeatWrapping,e.wrapT=THREE.RepeatWrapping,r.sphericalReflectionMapping===!0&&(e.mapping=THREE.SphericalReflectionMapping);for(var t=0;t<o.readyCallbacks.length;t++)o.readyCallbacks[t](o);delete o.readyCallbacks});o.readyCallbacks=[];var s=THREE.Math.generateUUID();return h[s]=o,s}function i(e,t){return void 0===t[e]&&console.warn("THREE.MMDLoader: Undefined texture",e),t[e]}function s(e){e.map.readyCallbacks.push(function(t){function r(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var r=t.getContext("2d");return r.drawImage(e,0,0),r.getImageData(0,0,t.width,t.height)}function i(e,t,r){var i=e.width,n=e.height,o=e.data,s=253;if(o.length/(i*n)!==4)return!1;for(var l=0;l<r.length;l+=3){for(var u={x:0,y:0},h=0;h<3;h++){var d=r[3*l+h],f={x:t[2*d+0],y:t[2*d+1]};if(a(e,f)<s)return!0;u.x+=f.x,u.y+=f.y}if(u.x/=3,u.y/=3,a(e,u)<s)return!0}return!1}function a(e,t){var r=e.width,i=e.height,a=Math.round(t.x*r)%r,n=Math.round(t.y*i)%i;a<0&&(a+=r),n<0&&(n+=i);var o=n*r+a;return e.data[4*o+3]}var o=void 0!==t.image.data?t.image:r(t.image),s=n.index.array.slice(3*e.faceOffset,3*e.faceOffset+3*e.faceNum);i(o,n.attributes.uv.array,s)&&(e.transparent=!0),delete e.faceOffset,delete e.faceNum})}function l(e){return 10===e.length&&null!==e.match(/toon(10|0[0-9]).bmp/)}function u(e,t){if(8===e.type)for(var r=0;r<t.length;r++){var i=t[r];if(i.index!==-1){var a=o.materials[i.index];a.uniforms.opacity.value!==i.diffuse[3]&&(a.transparent=!0)}}}for(var h=[],d=new THREE.TextureLoader(this.manager),f=new THREE.TGALoader(this.manager),c=0,m=[],p=0;p<e.metadata.materialCount;p++){var g=e.materials[p],v={};if(v.faceOffset=c,v.faceNum=g.faceCount,c+=g.faceCount,v.name=g.name,v.color=new THREE.Color(g.diffuse[0],g.diffuse[1],g.diffuse[2]),v.opacity=g.diffuse[3],v.specular=new THREE.Color(g.specular[0],g.specular[1],g.specular[2]),v.shininess=g.shininess,1===v.opacity?(v.side=THREE.FrontSide,v.transparent=!1):(v.side=THREE.DoubleSide,v.transparent=!0),"pmd"===e.metadata.format){if(g.fileName){var E=g.fileName,A=[],y=E.lastIndexOf("*");y>=0?(A.push(E.slice(0,y)),A.push(E.slice(y+1))):A.push(E);for(var T=0;T<A.length;T++){var M=A[T];M.indexOf(".sph")>=0||M.indexOf(".spa")>=0?(v.envMap=r(M,{sphericalReflectionMapping:!0}),M.indexOf(".sph")>=0?v.envMapType=THREE.MultiplyOperation:v.envMapType=THREE.AddOperation):v.map=r(M)}}}else{if(g.textureIndex!==-1){var M=e.textures[g.textureIndex];v.map=r(M)}if(g.envTextureIndex!==-1&&(1===g.envFlag||2==g.envFlag)){var M=e.textures[g.envTextureIndex];v.envMap=r(M,{sphericalReflectionMapping:!0}),1===g.envFlag?v.envMapType=THREE.MultiplyOperation:v.envMapType=THREE.AddOperation}}var R=void 0===v.map?1:.2;v.emissive=new THREE.Color(g.ambient[0]*R,g.ambient[1]*R,g.ambient[2]*R),m.push(v)}for(var x=THREE.ShaderLib.mmd,p=0;p<m.length;p++){var b=m[p],C=e.materials[p],g=new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(x.uniforms),vertexShader:x.vertexShader,fragmentShader:x.fragmentShader});if(n.addGroup(3*b.faceOffset,3*b.faceNum,p),void 0!==b.name&&(g.name=b.name),g.skinning=n.bones.length>0,g.morphTargets=n.morphTargets.length>0,g.lights=!0,g.side="pmx"===e.metadata.format&&1===(1&C.flag)?THREE.DoubleSide:b.side,g.transparent=b.transparent,g.fog=!0,g.blending=THREE.CustomBlending,g.blendSrc=THREE.SrcAlphaFactor,g.blendDst=THREE.OneMinusSrcAlphaFactor,g.blendSrcAlpha=THREE.SrcAlphaFactor,g.blendDstAlpha=THREE.DstAlphaFactor,void 0!==b.map&&(g.faceOffset=b.faceOffset,g.faceNum=b.faceNum,g.map=i(b.map,h),g.uniforms.map.value=g.map,s(g)),void 0!==b.envMap&&(g.envMap=i(b.envMap,h),g.uniforms.envMap.value=g.envMap,g.combine=b.envMapType,g.envMap.readyCallbacks.push(function(e){g.needsUpdate=!0})),g.uniforms.opacity.value=b.opacity,g.uniforms.diffuse.value.copy(b.color),void 0!==b.emissive&&g.uniforms.emissive.value.copy(b.emissive),g.uniforms.specular.value.copy(b.specular),g.uniforms.shininess.value=Math.max(b.shininess,1e-4),"pmd"===e.metadata.format)if(g.outlineParameters={thickness:1===C.edgeFlag?.003:0,color:new THREE.Color(0,0,0),alpha:1},0===g.outlineParameters.thickness&&(g.outlineParameters.visible=!1),g.uniforms.toonMap.value=h[C.toonIndex],g.uniforms.celShading.value=1,C.toonIndex===-1)g.uniforms.hasToonTexture.value=0;else{var M=e.toonTextures[C.toonIndex].fileName,H=r(M,{defaultTexturePath:l(M)});g.uniforms.toonMap.value=h[H],g.uniforms.hasToonTexture.value=1}else if(g.outlineParameters={thickness:C.edgeSize/300,color:new THREE.Color(C.edgeColor[0],C.edgeColor[1],C.edgeColor[2]),alpha:C.edgeColor[3]},0!==(16&C.flag)&&0!==g.outlineParameters.thickness||(g.outlineParameters.visible=!1),g.uniforms.celShading.value=1,C.toonIndex===-1)g.uniforms.hasToonTexture.value=0;else{if(0===C.toonFlag){var M=e.textures[C.toonIndex],H=r(M);g.uniforms.toonMap.value=h[H]}else{var w=C.toonIndex+1,E="toon"+(w<10?"0"+w:w)+".bmp",H=r(E,{defaultTexturePath:!0});g.uniforms.toonMap.value=h[H]}g.uniforms.hasToonTexture.value=1}o.materials.push(g)}if("pmx"===e.metadata.format)for(var p=0;p<e.morphs.length;p++){var I=e.morphs[p],B=I.elements;if(0===I.type)for(var T=0;T<B.length;T++){var k=e.morphs[B[T].index],S=k.elements;u(k,S)}else u(I,B)}},p=function(){for(var t=[],r=[],i=0;i<e.metadata.rigidBodyCount;i++){for(var a=e.rigidBodies[i],o=Object.keys(a),s={},l=0;l<o.length;l++){var u=o[l];s[u]=a[u]}if("pmx"===e.metadata.format&&s.boneIndex!==-1){var h=e.bones[s.boneIndex];s.position[0]-=h.position[0],s.position[1]-=h.position[1],s.position[2]-=h.position[2]}t.push(s)}for(var i=0;i<e.metadata.constraintCount;i++){for(var d=e.constraints[i],o=Object.keys(d),s={},l=0;l<o.length;l++){var u=o[l];s[u]=d[u]}var f=t[s.rigidBodyIndex1],c=t[s.rigidBodyIndex2];0!==f.type&&2===c.type&&f.boneIndex!==-1&&c.boneIndex!==-1&&e.bones[c.boneIndex].parentIndex===f.boneIndex&&(c.type=1),r.push(s)}n.rigidBodies=t,n.constraints=r},g=function(){n.setIndex(new(s.indices.length>65535?THREE.Uint32BufferAttribute:THREE.Uint16BufferAttribute)(s.indices,1)),n.addAttribute("position",new THREE.Float32BufferAttribute(s.vertices,3)),n.addAttribute("normal",new THREE.Float32BufferAttribute(s.normals,3)),n.addAttribute("uv",new THREE.Float32BufferAttribute(s.uvs,2)),n.addAttribute("skinIndex",new THREE.Float32BufferAttribute(s.skinIndices,4)),n.addAttribute("skinWeight",new THREE.Float32BufferAttribute(s.skinWeights,4)),n.computeBoundingSphere(),n.mmdFormat=e.metadata.format};this.leftToRightModel(e),l(),u(),h(),d(),f(),c(),m(),p(),g();var v=new THREE.SkinnedMesh(n,o);return v},THREE.MMDLoader.prototype.createAnimation=function(e,t,r){var i=new THREE.MMDLoader.DataCreationHelper,a=function(){if(0!==t.metadata.motionCount){for(var a=e.geometry.bones,n=i.createOrderedMotionArrays(a,t.motions,"boneName"),o=[],s=function(e,t,r){e.push(t[r+0]/127),e.push(t[r+8]/127),e.push(t[r+4]/127),e.push(t[r+12]/127)},l=0;l<n.length;l++){for(var u=[],h=[],d=[],f=[],c=[],m=a[l],p=n[l],g=0;g<p.length;g++){var v=p[g].frameNum/30,E=p[g].position,A=p[g].rotation,y=p[g].interpolation;u.push(v);for(var T=0;T<3;T++)h.push(m.pos[T]+E[T]);for(var T=0;T<4;T++)d.push(A[T]);for(var T=0;T<3;T++)s(f,y,T);s(c,y,3)}if(0!==u.length){var M=".bones["+m.name+"]";o.push(new THREE.MMDLoader.VectorKeyframeTrackEx(M+".position",u,h,f)),o.push(new THREE.MMDLoader.QuaternionKeyframeTrackEx(M+".quaternion",u,d,c))}}var R=new THREE.AnimationClip(void 0===r?THREE.Math.generateUUID():r,-1,o);null!==R&&(void 0===e.geometry.animations&&(e.geometry.animations=[]),e.geometry.animations.push(R))}},n=function(){if(0!==t.metadata.morphCount){for(var a=i.createOrderedMotionArrays(e.geometry.morphTargets,t.morphs,"morphName"),n=[],o=0;o<a.length;o++){for(var s=[],l=[],u=a[o],h=0;h<u.length;h++)s.push(u[h].frameNum/30),l.push(u[h].weight);0!==s.length&&n.push(new THREE.NumberKeyframeTrack(".morphTargetInfluences["+o+"]",s,l))}var d=new THREE.AnimationClip(void 0===r?THREE.Math.generateUUID():r+"Morph",-1,n);null!==d&&(void 0===e.geometry.animations&&(e.geometry.animations=[]),e.geometry.animations.push(d))}};this.leftToRightVmd(t),a(),n()},THREE.MMDLoader.prototype.leftToRightModel=function(e){if("right"!==e.metadata.coordinateSystem){e.metadata.coordinateSystem="right";for(var t=new THREE.MMDLoader.DataCreationHelper,r=0;r<e.metadata.vertexCount;r++)t.leftToRightVector3(e.vertices[r].position),t.leftToRightVector3(e.vertices[r].normal);for(var r=0;r<e.metadata.faceCount;r++)t.leftToRightIndexOrder(e.faces[r].indices);for(var r=0;r<e.metadata.boneCount;r++)t.leftToRightVector3(e.bones[r].position);for(var r=0;r<e.metadata.morphCount;r++){var i=e.morphs[r];if("pmx"!==e.metadata.format||1===i.type)for(var a=0;a<i.elements.length;a++)t.leftToRightVector3(i.elements[a].position)}for(var r=0;r<e.metadata.rigidBodyCount;r++)t.leftToRightVector3(e.rigidBodies[r].position),
t.leftToRightEuler(e.rigidBodies[r].rotation);for(var r=0;r<e.metadata.constraintCount;r++)t.leftToRightVector3(e.constraints[r].position),t.leftToRightEuler(e.constraints[r].rotation),t.leftToRightVector3Range(e.constraints[r].translationLimitation1,e.constraints[r].translationLimitation2),t.leftToRightEulerRange(e.constraints[r].rotationLimitation1,e.constraints[r].rotationLimitation2)}},THREE.MMDLoader.prototype.leftToRightVmd=function(e){if("right"!==e.metadata.coordinateSystem){e.metadata.coordinateSystem="right";for(var t=new THREE.MMDLoader.DataCreationHelper,r=0;r<e.metadata.motionCount;r++)t.leftToRightVector3(e.motions[r].position),t.leftToRightQuaternion(e.motions[r].rotation);for(var r=0;r<e.metadata.cameraCount;r++)t.leftToRightVector3(e.cameras[r].position),t.leftToRightEuler(e.cameras[r].rotation)}},THREE.MMDLoader.prototype.leftToRightVpd=function(e){if("right"!==e.metadata.coordinateSystem){e.metadata.coordinateSystem="right";for(var t=new THREE.MMDLoader.DataCreationHelper,r=0;r<e.bones.length;r++)t.leftToRightVector3(e.bones[r].translation),t.leftToRightQuaternion(e.bones[r].quaternion)}},THREE.MMDLoader.DataCreationHelper=function(){},THREE.MMDLoader.DataCreationHelper.prototype={constructor:THREE.MMDLoader.Helper,leftToRightVector3:function(e){e[2]=-e[2]},leftToRightQuaternion:function(e){e[0]=-e[0],e[1]=-e[1]},leftToRightEuler:function(e){e[0]=-e[0],e[1]=-e[1]},leftToRightIndexOrder:function(e){var t=e[2];e[2]=e[0],e[0]=t},leftToRightVector3Range:function(e,t){var r=-t[2];t[2]=-e[2],e[2]=r},leftToRightEulerRange:function(e,t){var r=-t[0],i=-t[1];t[0]=-e[0],t[1]=-e[1],e[0]=r,e[1]=i},toCharcodeStrings:function(e){for(var t="",r=0;r<e.length;r++)t+="0x"+("0000"+e[r].charCodeAt().toString(16)).substr(-4);return t},createDictionary:function(e){for(var t={},r=0;r<e.length;r++)t[e[r].name]=r;return t},initializeMotionArrays:function(e){for(var t=[],r=0;r<e.length;r++)t[r]=[];return t},sortMotionArray:function(e){e.sort(function(e,t){return e.frameNum-t.frameNum})},sortMotionArrays:function(e){for(var t=0;t<e.length;t++)this.sortMotionArray(e[t])},createMotionArray:function(e){for(var t=[],r=0;r<e.length;r++)t.push(e[r]);return t},createMotionArrays:function(e,t,r,i){for(var a=0;a<e.length;a++){var n=e[a],o=r[n[i]];void 0!==o&&t[o].push(n)}},createOrderedMotionArray:function(e){var t=this.createMotionArray(e);return this.sortMotionArray(t),t},createOrderedMotionArrays:function(e,t,r){var i=this.createDictionary(e),a=this.initializeMotionArrays(e);return this.createMotionArrays(t,a,i,r),this.sortMotionArrays(a),a}},THREE.MMDLoader.VectorKeyframeTrackEx=function(e,t,r,i){this.interpolationParameters=new Float32Array(i),THREE.VectorKeyframeTrack.call(this,e,t,r)},THREE.MMDLoader.VectorKeyframeTrackEx.prototype=Object.create(THREE.VectorKeyframeTrack.prototype),THREE.MMDLoader.VectorKeyframeTrackEx.prototype.constructor=THREE.MMDLoader.VectorKeyframeTrackEx,THREE.MMDLoader.VectorKeyframeTrackEx.prototype.TimeBufferType=Float64Array,THREE.MMDLoader.VectorKeyframeTrackEx.prototype.InterpolantFactoryMethodCubicBezier=function(e){return new THREE.MMDLoader.CubicBezierInterpolation(this.times,this.values,this.getValueSize(),e,this.interpolationParameters)},THREE.MMDLoader.VectorKeyframeTrackEx.prototype.setInterpolation=function(e){this.createInterpolant=this.InterpolantFactoryMethodCubicBezier},THREE.MMDLoader.QuaternionKeyframeTrackEx=function(e,t,r,i){this.interpolationParameters=new Float32Array(i),THREE.QuaternionKeyframeTrack.call(this,e,t,r)},THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype=Object.create(THREE.QuaternionKeyframeTrack.prototype),THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype.constructor=THREE.MMDLoader.QuaternionKeyframeTrackEx,THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype.TimeBufferType=Float64Array,THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype.InterpolantFactoryMethodCubicBezier=function(e){return new THREE.MMDLoader.CubicBezierInterpolation(this.times,this.values,this.getValueSize(),e,this.interpolationParameters)},THREE.MMDLoader.QuaternionKeyframeTrackEx.prototype.setInterpolation=function(e){this.createInterpolant=this.InterpolantFactoryMethodCubicBezier},THREE.MMDLoader.NumberKeyframeTrackEx=function(e,t,r,i){this.interpolationParameters=new Float32Array(i),THREE.NumberKeyframeTrack.call(this,e,t,r)},THREE.MMDLoader.NumberKeyframeTrackEx.prototype=Object.create(THREE.NumberKeyframeTrack.prototype),THREE.MMDLoader.NumberKeyframeTrackEx.prototype.constructor=THREE.MMDLoader.NumberKeyframeTrackEx,THREE.MMDLoader.NumberKeyframeTrackEx.prototype.TimeBufferType=Float64Array,THREE.MMDLoader.NumberKeyframeTrackEx.prototype.InterpolantFactoryMethodCubicBezier=function(e){return new THREE.MMDLoader.CubicBezierInterpolation(this.times,this.values,this.getValueSize(),e,this.interpolationParameters)},THREE.MMDLoader.NumberKeyframeTrackEx.prototype.setInterpolation=function(e){this.createInterpolant=this.InterpolantFactoryMethodCubicBezier},THREE.MMDLoader.CubicBezierInterpolation=function(e,t,r,i,a){THREE.Interpolant.call(this,e,t,r,i),this.params=a},THREE.MMDLoader.CubicBezierInterpolation.prototype=Object.create(THREE.LinearInterpolant.prototype),THREE.MMDLoader.CubicBezierInterpolation.prototype.constructor=THREE.MMDLoader.CubicBezierInterpolation,THREE.MMDLoader.CubicBezierInterpolation.prototype.interpolate_=function(e,t,r,i){var a=this.resultBuffer,n=this.sampleValues,o=this.valueSize,s=e*o,l=s-o,u=(r-t)/(i-t);if(4===o){var h=this.params[4*e+0],d=this.params[4*e+1],f=this.params[4*e+2],c=this.params[4*e+3],m=this._calculate(h,d,f,c,u);THREE.Quaternion.slerpFlat(a,0,n,l,n,s,m)}else if(3===o)for(var p=0;p!==o;++p){var h=this.params[12*e+4*p+0],d=this.params[12*e+4*p+1],f=this.params[12*e+4*p+2],c=this.params[12*e+4*p+3],m=this._calculate(h,d,f,c,u);a[p]=n[l+p]*(1-m)+n[s+p]*m}else{var h=this.params[4*e+0],d=this.params[4*e+1],f=this.params[4*e+2],c=this.params[4*e+3],m=this._calculate(h,d,f,c,u);a[0]=n[l]*(1-m)+n[s]*m}return a},THREE.MMDLoader.CubicBezierInterpolation.prototype._calculate=function(e,t,r,i,a){for(var n,o,s,l=.5,u=l,h=1-u,d=15,f=1e-5,c=Math,m=0;m<d;m++){n=3*h*h*u,o=3*h*u*u,s=u*u*u;var p=n*e+o*t+s-a;if(c.abs(p)<f)break;l/=2,u+=p<0?l:-l,h=1-u}return n*r+o*i+s},THREE.MMDLoader.DataView=function(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t,this.encoder=new CharsetEncoder},THREE.MMDLoader.DataView.prototype={constructor:THREE.MMDLoader.DataView,getInt8:function(){var e=this.dv.getInt8(this.offset);return this.offset+=1,e},getInt8Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getInt8());return t},getUint8:function(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e},getUint8Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getUint8());return t},getInt16:function(){var e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},getInt16Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getInt16());return t},getUint16:function(){var e=this.dv.getUint16(this.offset,this.littleEndian);return this.offset+=2,e},getUint16Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getUint16());return t},getInt32:function(){var e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},getInt32Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getInt32());return t},getUint32:function(){var e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},getUint32Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getUint32());return t},getFloat32:function(){var e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},getFloat32Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getFloat32());return t},getFloat64:function(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},getFloat64Array:function(e){for(var t=[],r=0;r<e;r++)t.push(this.getFloat64());return t},getIndex:function(e,t){switch(e){case 1:return t===!0?this.getUint8():this.getInt8();case 2:return t===!0?this.getUint16():this.getInt16();case 4:return this.getInt32();default:throw"unknown number type "+e+" exception."}},getIndexArray:function(e,t,r){for(var i=[],a=0;a<t;a++)i.push(this.getIndex(e,r));return i},getChars:function(e){for(var t="";e>0;){var r=this.getUint8();if(e--,0===r)break;t+=String.fromCharCode(r)}for(;e>0;)this.getUint8(),e--;return t},getSjisStringsAsUnicode:function(e){for(var t=[];e>0;){var r=this.getUint8();if(e--,0===r)break;t.push(r)}for(;e>0;)this.getUint8(),e--;return this.encoder.s2u(new Uint8Array(t))},getUnicodeStrings:function(e){for(var t="";e>0;){var r=this.getUint16();if(e-=2,0===r)break;t+=String.fromCharCode(r)}for(;e>0;)this.getUint8(),e--;return t},getTextBuffer:function(){var e=this.getUint32();return this.getUnicodeStrings(e)}},THREE.ShaderLib.mmd={uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.phong.uniforms,{celShading:{type:"i",value:0},toonMap:{type:"t",value:null},hasToonTexture:{type:"i",value:0}}]),vertexShader:THREE.ShaderLib.phong.vertexShader,fragmentShader:THREE.ShaderLib.phong.fragmentShader.replace(/void\s+main\s*\(\s*\)/,["\tuniform bool celShading;","\tuniform sampler2D toonMap;","\tuniform bool hasToonTexture;","\tvec3 toon ( vec3 lightDirection, vec3 norm ) {","\t\tif ( ! hasToonTexture ) {","\t\t\treturn vec3( 1.0 );","\t\t}","\t\tvec2 coord = vec2( 0.0, 0.5 * ( 1.0 - dot( lightDirection, norm ) ) );","\t\treturn texture2D( toonMap, coord ).rgb;","\t}","#undef RE_Direct","void RE_Direct_BlinnMMD( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {","\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );","\tvec3 irradiance = dotNL * directLight.color;","\t#ifndef PHYSICALLY_CORRECT_LIGHTS","\t\tirradiance *= PI; // punctual light","\t#endif","\tif ( celShading ) {","\t\treflectedLight.directDiffuse += material.diffuseColor * directLight.color * toon( directLight.direction, geometry.normal );","\t} else {","\t\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );","\t}","\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;","}","#define RE_Direct\tRE_Direct_BlinnMMD","void main()"].join("\n"))},THREE.MMDAudioManager=function(e,t,r){var i=null===r||void 0===r?{}:r;this.audio=e,this.listener=t,this.elapsedTime=0,this.currentTime=0,this.delayTime=void 0!==i.delayTime?i.delayTime:0,this.audioDuration=this.audio.source.buffer.duration,this.duration=this.audioDuration+this.delayTime},THREE.MMDAudioManager.prototype={constructor:THREE.MMDAudioManager,control:function(e){this.elapsed+=e,this.currentTime+=e,this.checkIfStopAudio()&&this.audio.stop(),this.checkIfStartAudio()&&this.audio.play()},checkIfStartAudio:function(){if(this.audio.isPlaying)return!1;for(;this.currentTime>=this.duration;)this.currentTime-=this.duration;return!(this.currentTime<this.delayTime)&&(this.audio.startTime=this.currentTime-this.delayTime,!0)},checkIfStopAudio:function(){return!!this.audio.isPlaying&&this.currentTime>=this.duration}},THREE.MMDGrantSolver=function(e){this.mesh=e},THREE.MMDGrantSolver.prototype={constructor:THREE.MMDGrantSolver,update:function(){var e=new THREE.Quaternion;return function(){for(var t=0;t<this.mesh.geometry.grants.length;t++){var r=this.mesh.geometry.grants[t],i=this.mesh.skeleton.bones[r.index],a=this.mesh.skeleton.bones[r.parentIndex];r.isLocal?(r.affectPosition,r.affectRotation):(r.affectPosition,r.affectRotation&&(e.set(0,0,0,1),e.slerp(a.quaternion,r.ratio),i.quaternion.multiply(e)))}}}()},THREE.MMDHelper=function(e){this.renderer=e,this.outlineEffect=null,this.effect=null,this.autoClear=!0,this.meshes=[],this.doAnimation=!0,this.doIk=!0,this.doGrant=!0,this.doPhysics=!0,this.doOutlineDrawing=!0,this.doCameraAnimation=!0,this.audioManager=null,this.camera=null,this.init()},THREE.MMDHelper.prototype={constructor:THREE.MMDHelper,init:function(){this.outlineEffect=new THREE.OutlineEffect(this.renderer);var e=this.renderer.getSize();this.setSize(e.width,e.height)},add:function(e){if(!(e instanceof THREE.SkinnedMesh))throw new Error("THREE.MMDHelper.add() accepts only THREE.SkinnedMesh instance.");void 0===e.mixer&&(e.mixer=null),void 0===e.ikSolver&&(e.ikSolver=null),void 0===e.grantSolver&&(e.grantSolver=null),void 0===e.physics&&(e.physics=null),void 0===e.looped&&(e.looped=!1),this.meshes.push(e),this.initBackupBones(e)},setSize:function(e,t){this.outlineEffect.setSize(e,t)},setEffect:function(e){this.effect=e},setAudio:function(e,t,r){this.audioManager=new THREE.MMDAudioManager(e,t,r)},setCamera:function(e){e.mixer=null,this.camera=e},setPhysicses:function(e){for(var t=0;t<this.meshes.length;t++)this.setPhysics(this.meshes[t],e)},setPhysics:function(e,t){void 0===t&&(t={});var r=void 0!==t.warmup?t.warmup:60,i=new THREE.MMDPhysics(e,t);null!==e.mixer&&void 0!==e.mixer&&this.doAnimation===!0&&t.preventAnimationWarmup!==!1&&(this.animateOneMesh(0,e),i.reset()),i.warmup(r),this.updateIKParametersDependingOnPhysicsEnabled(e,!0),e.physics=i},enablePhysics:function(e){e===!0?this.doPhysics=!0:this.doPhysics=!1;for(var t=0,r=this.meshes.length;t<r;t++)this.updateIKParametersDependingOnPhysicsEnabled(this.meshes[t],e)},updateIKParametersDependingOnPhysicsEnabled:function(e,t){for(var r=e.geometry.iks,i=e.geometry.bones,a=0,n=r.length;a<n;a++)for(var o=r[a],s=o.links,l=0,u=s.length;l<u;l++){var h=s[l];t===!0?h.enabled=!(i[h.index].rigidBodyType>0):h.enabled=!0}},setAnimations:function(){for(var e=0;e<this.meshes.length;e++)this.setAnimation(this.meshes[e])},setAnimation:function(e){if(void 0!==e.geometry.animations){e.mixer=new THREE.AnimationMixer(e),e.mixer.addEventListener("loop",function(e){if(0===e.action._clip.tracks[0].name.indexOf(".bones")){var t=e.target._root;t.looped=!0}});for(var t=!1,r=!1,i=0;i<e.geometry.animations.length;i++){var a=e.geometry.animations[i],n=e.mixer.clipAction(a);0===a.tracks[0].name.indexOf(".morphTargetInfluences")?r||(n.play(),r=!0):t||(n.play(),t=!0)}t&&(e.ikSolver=new THREE.CCDIKSolver(e),void 0!==e.geometry.grants&&(e.grantSolver=new THREE.MMDGrantSolver(e)))}},setCameraAnimation:function(e){void 0!==e.animations&&(e.mixer=new THREE.AnimationMixer(e),e.mixer.clipAction(e.animations[0]).play())},unifyAnimationDuration:function(e){e=void 0===e?{}:e;for(var t=0,r=this.camera,i=this.audioManager,a=0;a<this.meshes.length;a++){var n=this.meshes[a],o=n.mixer;if(null!==o)for(var s=0;s<o._actions.length;s++){var l=o._actions[s];t=Math.max(t,l._clip.duration)}}if(null!==r&&null!==r.mixer)for(var o=r.mixer,a=0;a<o._actions.length;a++){var l=o._actions[a];t=Math.max(t,l._clip.duration)}null!==i&&(t=Math.max(t,i.duration)),void 0!==e.afterglow&&(t+=e.afterglow);for(var a=0;a<this.meshes.length;a++){var n=this.meshes[a],o=n.mixer;if(null!==o)for(var s=0;s<o._actions.length;s++){var l=o._actions[s];l._clip.duration=t}}if(null!==r&&null!==r.mixer)for(var o=r.mixer,a=0;a<o._actions.length;a++){var l=o._actions[a];l._clip.duration=t}null!==i&&(i.duration=t)},controlAudio:function(e){null!==this.audioManager&&this.audioManager.control(e)},animate:function(e){this.controlAudio(e);for(var t=0;t<this.meshes.length;t++)this.animateOneMesh(e,this.meshes[t]);this.animateCamera(e)},animateOneMesh:function(e,t){var r=t.mixer,i=t.ikSolver,a=t.grantSolver,n=t.physics;null!==r&&this.doAnimation===!0&&(this.restoreBones(t),r.update(e),this.backupBones(t)),null!==i&&this.doIk===!0&&i.update(),null!==a&&this.doGrant===!0&&a.update(),t.looped===!0&&(null!==n&&n.reset(),t.looped=!1),null!==n&&this.doPhysics===!0&&n.update(e)},animateCamera:function(e){if(null!==this.camera){var t=this.camera.mixer;null!==t&&void 0!==this.camera.center&&this.doCameraAnimation===!0&&(t.update(e),this.camera.updateProjectionMatrix(),this.camera.up.set(0,1,0),this.camera.up.applyQuaternion(this.camera.quaternion),this.camera.lookAt(this.camera.center))}},render:function(e,t){if(null===this.effect)if(this.doOutlineDrawing)this.outlineEffect.autoClear=this.autoClear,this.outlineEffect.render(e,t);else{var r=this.renderer.autoClear;this.renderer.autoClear=this.autoClear,this.renderer.render(e,t),this.renderer.autoClear=r}else{var r=this.renderer.autoClear;this.renderer.autoClear=this.autoClear,this.doOutlineDrawing?this.renderWithEffectAndOutline(e,t):this.effect.render(e,t),this.renderer.autoClear=r}},renderWithEffectAndOutline:function(e,t){function r(e){void 0!==e.material&&void 0!==e.userData.outlineMaterial&&(n=!0)}function i(e){void 0!==e.material&&void 0!==e.userData.outlineMaterial&&(e.userData.originalMaterial=e.material,e.material=e.userData.outlineMaterial)}function a(e){void 0!==e.material&&void 0!==e.userData.originalMaterial&&(e.material=e.userData.originalMaterial)}var n=!1;return function(e,t){n=!1;var o=!1;if(e.traverse(r),n||(this.outlineEffect.render(e,t),o=!0,e.traverse(r)),n){this.renderer.autoClear=this.autoClear||o,this.effect.render(e,t),e.traverse(i);var s=this.renderer.shadowMap.enabled;this.renderer.autoClear=!1,this.renderer.shadowMap.enabled=!1,this.effect.render(e,t),this.renderer.shadowMap.enabled=s,e.traverse(a)}else this.outlineEffect.autoClear=this.autoClear||o,this.outlineEffect.render(e,t)}}(),poseAsVpd:function(e,t,r){r&&r.preventResetPose===!0||e.pose();for(var i=e.skeleton.bones,a=t.bones,n={},o=0;o<i.length;o++){var s=i[o];n[s.name]=o}for(var l=new THREE.Vector3,u=new THREE.Quaternion,o=0;o<a.length;o++){var s=a[o],h=n[s.name];if(void 0!==h){var d=i[h],f=s.translation,c=s.quaternion;l.set(f[0],f[1],f[2]),u.set(c[0],c[1],c[2],c[3]),d.position.add(l),d.quaternion.multiply(u),d.updateMatrixWorld(!0)}}if(void 0===r||r.preventIk!==!0){var m=new THREE.CCDIKSolver(e);m.update()}if((void 0===r||r.preventGrant!==!0)&&void 0!==e.geometry.grants){var m=new THREE.MMDGrantSolver(e);m.update()}},initBackupBones:function(e){e.skeleton.backupBones=[];for(var t=0;t<e.skeleton.bones.length;t++)e.skeleton.backupBones.push(e.skeleton.bones[t].clone())},backupBones:function(e){e.skeleton.backupBoneIsSaved=!0;for(var t=0;t<e.skeleton.bones.length;t++){var r=e.skeleton.backupBones[t],i=e.skeleton.bones[t];r.position.copy(i.position),r.quaternion.copy(i.quaternion)}},restoreBones:function(e){if(e.skeleton.backupBoneIsSaved===!0){e.skeleton.backupBoneIsSaved=!1;for(var t=0;t<e.skeleton.bones.length;t++){var r=e.skeleton.bones[t],i=e.skeleton.backupBones[t];r.position.copy(i.position),r.quaternion.copy(i.quaternion)}}}}},function(e,t){THREE.TGALoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.TGALoader.prototype.load=function(e,t,r,i){var a=this,n=new THREE.Texture,o=new THREE.XHRLoader(this.manager);return o.setResponseType("arraybuffer"),o.load(e,function(e){n.image=a.parse(e),n.needsUpdate=!0,void 0!==t&&t(n)},r,i),n},THREE.TGALoader.prototype.parse=function(e){function t(e){switch(e.image_type){case d:case m:(e.colormap_length>256||24!==e.colormap_size||1!==e.colormap_type)&&console.error("THREE.TGALoader.parse.tgaCheckHeader: Invalid type colormap data for indexed type");break;case f:case c:case p:case g:e.colormap_type&&console.error("THREE.TGALoader.parse.tgaCheckHeader: Invalid type colormap data for colormap type");break;case h:console.error("THREE.TGALoader.parse.tgaCheckHeader: No data");default:console.error('THREE.TGALoader.parse.tgaCheckHeader: Invalid type " '+e.image_type+'"')}(e.width<=0||e.height<=0)&&console.error("THREE.TGALoader.parse.tgaCheckHeader: Invalid image size"),8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&console.error('THREE.TGALoader.parse.tgaCheckHeader: Invalid pixel size "'+e.pixel_size+'"')}function r(e,t,r,i,a){var n,o,s,l;if(o=r.pixel_size>>3,s=r.width*r.height*o,t&&(l=a.subarray(i,i+=r.colormap_length*(r.colormap_size>>3))),e){n=new Uint8Array(s);for(var u,h,d,f=0,c=new Uint8Array(o);f<s;)if(u=a[i++],h=(127&u)+1,128&u){for(d=0;d<o;++d)c[d]=a[i++];for(d=0;d<h;++d)n.set(c,f+d*o);f+=o*h}else{for(h*=o,d=0;d<h;++d)n[f+d]=a[i++];f+=h}}else n=a.subarray(i,i+=t?r.width*r.height:s);return{pixel_data:n,palettes:l}}function i(e,t,r,i,a,n,o,s,l){var u,h,d,f=l,c=0,m=b.width;for(d=t;d!==i;d+=r)for(h=a;h!==o;h+=n,c++)u=s[c],e[4*(h+m*d)+3]=255,e[4*(h+m*d)+2]=f[3*u+0],e[4*(h+m*d)+1]=f[3*u+1],e[4*(h+m*d)+0]=f[3*u+2];return e}function a(e,t,r,i,a,n,o,s){var l,u,h,d=0,f=b.width;for(h=t;h!==i;h+=r)for(u=a;u!==o;u+=n,d+=2)l=s[d+0]+(s[d+1]<<8),e[4*(u+f*h)+0]=(31744&l)>>7,e[4*(u+f*h)+1]=(992&l)>>2,e[4*(u+f*h)+2]=(31&l)>>3,e[4*(u+f*h)+3]=32768&l?0:255;return e}function n(e,t,r,i,a,n,o,s){var l,u,h=0,d=b.width;for(u=t;u!==i;u+=r)for(l=a;l!==o;l+=n,h+=3)e[4*(l+d*u)+3]=255,e[4*(l+d*u)+2]=s[h+0],e[4*(l+d*u)+1]=s[h+1],e[4*(l+d*u)+0]=s[h+2];return e}function o(e,t,r,i,a,n,o,s){var l,u,h=0,d=b.width;for(u=t;u!==i;u+=r)for(l=a;l!==o;l+=n,h+=4)e[4*(l+d*u)+2]=s[h+0],e[4*(l+d*u)+1]=s[h+1],e[4*(l+d*u)+0]=s[h+2],e[4*(l+d*u)+3]=s[h+3];return e}function s(e,t,r,i,a,n,o,s){var l,u,h,d=0,f=b.width;for(h=t;h!==i;h+=r)for(u=a;u!==o;u+=n,d++)l=s[d],e[4*(u+f*h)+0]=l,e[4*(u+f*h)+1]=l,e[4*(u+f*h)+2]=l,e[4*(u+f*h)+3]=255;return e}function l(e,t,r,i,a,n,o,s){var l,u,h=0,d=b.width;for(u=t;u!==i;u+=r)for(l=a;l!==o;l+=n,h+=2)e[4*(l+d*u)+0]=s[h+0],e[4*(l+d*u)+1]=s[h+0],e[4*(l+d*u)+2]=s[h+0],e[4*(l+d*u)+3]=s[h+1];return e}function u(e,t,r,u,h){var d,f,c,m,p,g;switch((b.flags&v)>>E){default:case T:d=0,c=1,p=t,f=0,m=1,g=r;break;case A:d=0,c=1,p=t,f=r-1,m=-1,g=-1;break;case M:d=t-1,c=-1,p=-1,f=0,m=1,g=r;break;case y:d=t-1,c=-1,p=-1,f=r-1,m=-1,g=-1}if(w)switch(b.pixel_size){case 8:s(e,f,m,g,d,c,p,u);break;case 16:l(e,f,m,g,d,c,p,u);break;default:console.error("THREE.TGALoader.parse.getTgaRGBA: not support this format")}else switch(b.pixel_size){case 8:i(e,f,m,g,d,c,p,u,h);break;case 16:a(e,f,m,g,d,c,p,u);break;case 24:n(e,f,m,g,d,c,p,u);break;case 32:o(e,f,m,g,d,c,p,u);break;default:console.error("THREE.TGALoader.parse.getTgaRGBA: not support this format")}return e}var h=0,d=1,f=2,c=3,m=9,p=10,g=11,v=48,E=4,A=0,y=1,T=2,M=3;e.length<19&&console.error("THREE.TGALoader.parse: Not enough data to contain header.");var R=new Uint8Array(e),x=0,b={id_length:R[x++],colormap_type:R[x++],image_type:R[x++],colormap_index:R[x++]|R[x++]<<8,colormap_length:R[x++]|R[x++]<<8,colormap_size:R[x++],origin:[R[x++]|R[x++]<<8,R[x++]|R[x++]<<8],width:R[x++]|R[x++]<<8,height:R[x++]|R[x++]<<8,pixel_size:R[x++],flags:R[x++]};t(b),b.id_length+x>e.length&&console.error("THREE.TGALoader.parse: No data"),x+=b.id_length;var C=!1,H=!1,w=!1;switch(b.image_type){case m:C=!0,H=!0;break;case d:H=!0;break;case p:C=!0;break;case f:break;case g:C=!0,w=!0;break;case c:w=!0}var I=document.createElement("canvas");I.width=b.width,I.height=b.height;var B=I.getContext("2d"),k=B.createImageData(b.width,b.height),S=r(C,H,b,x,R);u(k.data,b.width,b.height,S.pixel_data,S.palettes);return B.putImageData(k,0,0),I}}]);